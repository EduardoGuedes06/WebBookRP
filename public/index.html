<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ronaldo Pereira - Plataforma do Autor</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,700;0,800;1,600&family=Caveat:wght@600&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0f172a', secondary: '#334155', accent: '#d97706',
                        'accent-hover': '#b45309', 'bg-body': '#f8fafc', 'text-main': '#1e293b',
                        'amazon': '#FF9900', 'shopee': '#EE4D2D', 'ml': '#FFE600'
                    },
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                        hand: ['Caveat', 'cursive'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } }
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        body { -webkit-font-smoothing: antialiased; }
        .glass-header { background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(0,0,0,0.05); box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .card-interaction:hover { transform: translateY(-5px); box-shadow: 0 20px 40px -10px rgba(0,0,0,0.15); }
        .polaroid { background: white; padding: 1rem; padding-bottom: 3rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transform: rotate(-3deg); transition: transform 0.3s; }
        .polaroid:hover { transform: rotate(0deg) scale(1.02); z-index: 10; }
        .tape { background-color: rgba(255, 255, 255, 0.4); box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: absolute; height: 30px; width: 100px; transform: rotate(-45deg); opacity: 0.7; }
        .form-input:focus { outline: none; border-color: #d97706; box-shadow: 0 0 0 4px rgba(217, 119, 6, 0.1); }
        /* Admin Dashboard */
        .dashboard-card { background: white; border-radius: 1rem; padding: 1.5rem; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        /* Pagination */
        .pagination-btn { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-weight: 600; color: #64748b; background: white; border: 1px solid #e2e8f0; transition: all 0.3s; cursor: pointer; }
        .pagination-btn.active { background-color: #0f172a; color: white; border-color: #0f172a; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2); }
        .pagination-btn:hover:not(.active) { background-color: #f8fafc; border-color: #cbd5e1; color: #0f172a; }
        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="bg-bg-body text-text-main font-sans antialiased overflow-x-hidden selection:bg-accent selection:text-white">

    <div id="cropper-modal" class="hidden fixed inset-0 bg-black/90 z-[80] flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-4xl h-[70vh] bg-black rounded-lg overflow-hidden relative">
            <img id="cropper-image" src="" class="max-w-full block">
        </div>
        <div class="flex gap-4 mt-6">
            <button onclick="window.app.cancelCrop()" class="bg-white text-gray-800 px-6 py-3 rounded-full font-bold shadow-lg hover:bg-gray-100 transition">
                Cancelar
            </button>
            <button onclick="window.app.confirmCrop()" class="bg-accent text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-accent-hover transition flex items-center gap-2">
                <i class="ph-bold ph-crop"></i> Recortar & Confirmar
            </button>
        </div>
    </div>

    <div id="toast-container" class="fixed top-24 right-5 z-[100] flex flex-col gap-3 pointer-events-none"></div>

    <div id="header-container" class="fixed top-0 w-full z-50 transition-all duration-300"></div>

    <main id="app" class="min-h-screen pt-28 pb-16 px-4 md:px-8 max-w-7xl mx-auto">
    </main>

    <div id="footer-container"></div>

    <div id="modal-overlay" class="hidden fixed inset-0 bg-primary/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4 transition-opacity duration-300 opacity-0">
        <div id="modal-content" class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden transform transition-all scale-95 opacity-0 relative flex flex-col max-h-[90vh]">
            <div class="bg-white p-6 flex justify-between items-center border-b border-gray-100 z-10 shrink-0">
                <h3 id="modal-title" class="text-2xl font-serif font-bold text-primary">Título</h3>
                <button onclick="window.app.closeModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition"><i class="ph ph-x text-xl"></i></button>
            </div>
            <div id="modal-body" class="p-8 overflow-y-auto flex-grow bg-gray-50/50"></div>
            <div id="modal-footer" class="p-6 border-t border-gray-100 bg-white flex justify-end gap-3 z-10 shrink-0"></div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. TEMPLATES HTML
        // ==========================================
const TEMPLATES = {
            header: `
                <header class="w-full py-4 transition-all duration-300">
                    <div class="container mx-auto px-4 flex justify-between items-center">
                        <a href="#/" class="text-2xl font-bold text-primary tracking-tighter font-serif group flex items-center gap-2">
                            <span class="w-8 h-8 bg-primary text-white flex items-center justify-center rounded-lg font-serif italic text-xl group-hover:bg-accent transition shadow-lg">R</span>
                            <span>RONALDO <span class="text-accent">PEREIRA</span>.</span>
                        </a>

                        <nav class="hidden md:flex gap-6 items-center font-medium text-sm tracking-wide text-gray-600">
                            <a href="#/" class="hover:text-accent transition py-2 font-bold uppercase text-xs">Início</a>
                            <a href="#/livros" class="hover:text-accent transition py-2 font-bold uppercase text-xs">Livros</a>
                            <a href="#/servicos" class="hover:text-accent transition py-2 font-bold uppercase text-xs">Serviços</a>
                            <a href="#/comunidade" class="hover:text-accent transition py-2 font-bold uppercase text-xs text-accent">Comunidade</a>
                            <a href="#/autor" class="hover:text-accent transition py-2 font-bold uppercase text-xs">Sobre</a>
                            
                            <div class="h-6 w-px bg-gray-300 mx-2"></div>

                            <a href="#/painel" class="hover:text-primary transition py-2 font-bold uppercase text-xs flex items-center gap-1 text-gray-400 hover:text-gray-900" title="Acesso Restrito">
                                <i class="ph-fill ph-lock-key text-lg"></i> Painel
                            </a>
                        </nav>

                        <button id="menu-button" class="md:hidden text-2xl text-primary p-2">
                            <i class="ph ph-list"></i>
                        </button>
                    </div>

                    <div id="mobile-menu" class="hidden md:hidden absolute top-full left-0 w-full bg-white shadow-xl border-t border-gray-100 flex flex-col p-4 z-50 animate-fade-in">
                        <a href="#/" class="py-3 px-4 hover:bg-gray-50 rounded font-medium">Início</a>
                        <a href="#/livros" class="py-3 px-4 hover:bg-gray-50 rounded font-medium">Livros</a>
                        <a href="#/comunidade" class="py-3 px-4 hover:bg-gray-50 rounded font-medium text-accent">Comunidade</a>
                        <a href="#/autor" class="py-3 px-4 hover:bg-gray-50 rounded font-medium">Sobre</a>
                        <a href="#/painel" class="py-3 px-4 hover:bg-gray-50 rounded font-medium">Painel Admin</a>
                    </div>
                </header>
            `,
            home: `
                <section class="flex flex-col-reverse md:flex-row items-center gap-16 py-12 md:py-24 mb-20 animate-fade-in">
                    <div class="flex-1 space-y-8 text-center md:text-left z-10">
                        <div class="inline-flex items-center gap-2 bg-white border border-gray-200 px-4 py-1.5 rounded-full shadow-sm mb-2">
                            <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                            <span class="text-xs font-bold uppercase tracking-widest text-gray-600">Último Lançamento</span>
                        </div>
                        <h1 class="text-5xl md:text-7xl font-black text-primary leading-[1] tracking-tight">
                            Mundos que <br><span class="text-transparent bg-clip-text bg-gradient-to-r from-accent to-orange-400 font-serif italic pr-2">colidem.</span>
                        </h1>
                        <p class="text-lg md:text-xl text-gray-600 max-w-lg mx-auto md:mx-0 leading-relaxed font-medium">
                            Ficção especulativa de alto nível. Junte-se a milhares de leitores e explore o impossível.
                        </p>
                        <div class="flex flex-col sm:flex-row gap-4 justify-center md:justify-start pt-6">
                            <a href="#/livros" class="bg-primary text-white px-10 py-4 rounded-full font-bold shadow-xl hover:bg-slate-800 hover:shadow-2xl hover:scale-105 transition transform text-sm uppercase tracking-wide">
                                Ler Agora
                            </a>
                        </div>
                    </div>
                    
                    <div class="flex-1 flex justify-center relative w-full">
                        <div class="absolute inset-0 bg-gradient-to-tr from-accent/20 to-transparent blur-[100px] rounded-full"></div>
                        <img src="https://placehold.co/400x550/1e293b/FFF?text=Capa+Nova" class="rounded shadow-2xl rotate-3 hover:rotate-0 transition duration-700 w-full max-w-sm border-8 border-white relative z-10 animate-float" alt="Autor">
                    </div>
                </section>

                <section class="py-20">
                    <div class="flex items-end justify-between mb-12">
                        <div>
                             <h2 class="text-4xl font-bold text-primary font-serif mb-2">Em Destaque</h2>
                             <p class="text-gray-500">O que os leitores estão devorando agora.</p>
                        </div>
                        <a href="#/livros" class="text-sm font-bold text-accent hover:underline uppercase tracking-widest mb-2">Ver Catálogo -></a>
                    </div>
                    
                    <div id="home-highlights" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>
                </section>

                <section class="my-20 bg-primary rounded-[3rem] p-12 md:p-24 text-center relative overflow-hidden text-white shadow-2xl">
                    <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]"></div>
                    <div class="relative z-10 max-w-4xl mx-auto">
                        <i class="ph-fill ph-quotes text-6xl text-accent mb-6 opacity-50 block mx-auto"></i>
                        <h3 class="text-3xl md:text-5xl font-serif font-bold leading-tight mb-8">"Escrever é a única forma que encontrei de viver mil vidas em uma só. E convido você a viver elas comigo."</h3>
                        <p class="text-slate-400 font-medium tracking-widest uppercase text-sm">— Ronaldo Pereira</p>
                    </div>
                </section>
            `,

            book_details: `
                <div class="animate-fade-in pt-10">
                    <button onclick="history.back()" class="flex items-center gap-2 text-gray-500 hover:text-primary font-bold mb-8 transition">
                        <i class="ph-bold ph-arrow-left"></i> Voltar para Catálogo
                    </button>
                    
                    <div class="bg-white rounded-[2rem] shadow-2xl border border-gray-100 overflow-hidden">
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-0">
                            
                            <div class="md:col-span-5 bg-gray-100 p-10 flex items-center justify-center relative overflow-hidden">
                                <div class="absolute inset-0 bg-primary/5 opacity-50"></div>
                                <div class="absolute top-0 left-0 w-full h-full bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10"></div>
                                <img id="detail-img" src="" class="rounded-lg shadow-2xl w-3/4 max-w-sm rotate-1 relative z-10 hover:rotate-0 transition duration-500">
                                
                                <div class="absolute top-5 right-5 bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg transform rotate-3 animate-pulse">
                                    OFERTA ESPECIAL
                                </div>
                            </div>
                            
                            <div class="md:col-span-7 p-10 md:p-14 flex flex-col justify-center">
                                <span id="detail-genre" class="text-accent font-bold tracking-widest text-xs uppercase mb-3 block"></span>
                                <h1 id="detail-title" class="text-4xl md:text-5xl font-black text-primary mb-6 font-serif leading-tight"></h1>
                                
                                <div class="flex items-center gap-6 mb-8 text-sm text-gray-500">
                                    <span class="flex items-center gap-1"><i class="ph-fill ph-star text-yellow-400 text-lg"></i> 4.9 (120 reviews)</span>
                                    <span class="w-px h-4 bg-gray-300"></span>
                                    <span>320 Páginas</span>
                                </div>

                                <p class="text-gray-600 text-lg leading-relaxed mb-8 font-light">
                                    Uma narrativa envolvente que desafia a percepção da realidade. Prepare-se para não conseguir largar.
                                </p>

                                <div class="flex items-end gap-6 mb-6">
                                    <div class="text-4xl font-black text-primary" id="detail-price"></div>
                                    <p class="text-sm text-gray-400 pb-2 decoration-slice line-through decoration-red-500 decoration-2">De R$ 59,90</p>
                                    <span class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded mb-2">30% OFF</span>
                                </div>

                                <div class="bg-gradient-to-r from-orange-100 to-amber-50 border-l-4 border-accent p-4 mb-8 rounded-r-lg shadow-sm">
                                    <div class="flex items-start gap-3">
                                        <i class="ph-fill ph-tag text-accent text-2xl mt-1"></i>
                                        <div>
                                            <h4 class="font-bold text-gray-800">Promoção de Lançamento!</h4>
                                            <p class="text-sm text-gray-600">Compre agora e ganhe um marcador exclusivo.</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex flex-col gap-3 max-w-md">
                                    <a id="link-amazon" href="#" target="_blank" class="flex items-center justify-between px-6 py-4 bg-gray-900 text-white rounded-xl hover:bg-slate-800 transition shadow-lg group">
                                        <div class="flex items-center gap-3">
                                            <i class="ph-bold ph-amazon-logo text-2xl text-[#FF9900]"></i>
                                            <span class="font-bold">Comprar na Amazon</span>
                                        </div>
                                        <i class="ph-bold ph-arrow-right group-hover:translate-x-1 transition"></i>
                                    </a>

                                    <a id="link-ml" href="#" target="_blank" class="flex items-center justify-between px-6 py-4 bg-[#FFE600] text-blue-900 rounded-xl hover:bg-yellow-400 transition shadow-md group border border-yellow-400">
                                        <div class="flex items-center gap-3">
                                            <i class="ph-bold ph-shopping-bag-open text-2xl"></i>
                                            <span class="font-bold">Mercado Livre</span>
                                        </div>
                                        <i class="ph-bold ph-arrow-right group-hover:translate-x-1 transition"></i>
                                    </a>

                                    <a id="link-shopee" href="#" target="_blank" class="flex items-center justify-between px-6 py-4 bg-[#EE4D2D] text-white rounded-xl hover:bg-orange-600 transition shadow-md group">
                                        <div class="flex items-center gap-3">
                                            <i class="ph-bold ph-shopping-bag text-2xl"></i>
                                            <span class="font-bold">Shopee</span>
                                        </div>
                                        <i class="ph-bold ph-arrow-right group-hover:translate-x-1 transition"></i>
                                    </a>
                                </div>

                                <div class="mt-6 flex items-center gap-2">
                                     <button id="detail-fav-btn" class="flex items-center gap-2 text-gray-500 hover:text-red-500 transition font-bold text-sm px-4 py-2 rounded-lg hover:bg-red-50">
                                        <i id="detail-fav-icon" class="ph-fill ph-heart text-xl text-gray-300"></i> Adicionar aos Favoritos
                                     </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-16 grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="col-span-2">
                        <h3 class="text-2xl font-bold text-primary mb-6 font-serif">Sinopse Completa</h3>
                        <div class="prose text-gray-600 leading-loose">
                            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
                            <p class="mt-4">Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-2xl font-bold text-primary mb-6 font-serif">Outros Leitores</h3>
                        <div class="space-y-4">
                            <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                                <div class="flex text-yellow-400 text-xs mb-2"><i class="ph-fill ph-star"></i><i class="ph-fill ph-star"></i><i class="ph-fill ph-star"></i><i class="ph-fill ph-star"></i><i class="ph-fill ph-star"></i></div>
                                <p class="text-sm text-gray-600 italic">"Simplesmente fantástico. O final me pegou de surpresa!"</p>
                                <p class="text-xs font-bold text-gray-400 mt-2">- @leitora_voraz</p>
                            </div>
                            <div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm">
                                <div class="flex text-yellow-400 text-xs mb-2"><i class="ph-fill ph-star"></i><i class="ph-fill ph-star"></i><i class="ph-fill ph-star"></i><i class="ph-fill ph-star"></i><i class="ph-fill ph-star"></i></div>
                                <p class="text-sm text-gray-600 italic">"A construção de mundo é impecável."</p>
                                <p class="text-xs font-bold text-gray-400 mt-2">- Marcos D.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `,

            livros: `
                <div class="animate-fade-in pt-10 pb-20">
                    <div class="text-center mb-16">
                        <span class="text-accent font-bold tracking-[0.2em] text-xs uppercase mb-3 block">Biblioteca Oficial</span>
                        <h2 class="text-4xl md:text-5xl font-black text-primary mb-6 font-serif">Obras Publicadas</h2>
                        <p class="text-gray-500 max-w-2xl mx-auto text-lg">Coleção exclusiva. Escolha sua próxima aventura.</p>
                    </div>

                    <div class="max-w-6xl mx-auto">
                        <div id="books-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-10"></div>
                        <div id="pagination-controls" class="flex justify-center items-center gap-3 mt-16 pt-8 border-t border-gray-100"></div>
                    </div>
                </div>
            `,
            servicos: `
                <div class="text-center mb-16 animate-fade-in pt-10">
                    <h2 class="text-5xl font-black text-primary mb-6 font-serif">Mentoria & Serviços</h2>
                    <p class="text-gray-500 text-lg max-w-2xl mx-auto">
                        Do rascunho ao best-seller. Vamos trabalhar juntos na sua história.
                    </p>
                </div>
                <div id="services-grid" class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-7xl mx-auto"></div>
            `,
            community: `
                <div class="animate-fade-in pb-20">
                    <div class="relative bg-primary rounded-[3rem] p-10 md:p-24 text-center text-white mb-20 overflow-hidden shadow-2xl">
                        <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                        <div class="absolute -top-24 -right-24 w-64 h-64 bg-accent/20 rounded-full blur-3xl"></div>
                        <div class="absolute -bottom-24 -left-24 w-64 h-64 bg-blue-500/20 rounded-full blur-3xl"></div>
                        
                        <div class="relative z-10 max-w-3xl mx-auto">
                            <span class="inline-block py-1 px-4 rounded-full bg-white/10 backdrop-blur-md border border-white/20 text-xs font-bold uppercase tracking-widest mb-6 text-accent">Hub de Conteúdo</span>
                            <h2 class="text-5xl md:text-7xl font-serif font-bold mb-8 leading-tight">Bastidores & <br> <span class="italic text-transparent bg-clip-text bg-gradient-to-r from-accent to-orange-400">Café Quente.</span></h2>
                            <p class="text-slate-300 text-lg md:text-xl leading-relaxed">
                                Mergulhe no processo criativo, debata teorias e acesse conteúdos exclusivos para quem vive a literatura.
                            </p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12 max-w-7xl mx-auto">
                        <div class="lg:col-span-8 space-y-12" id="public-blog-feed"></div>

                        <div class="lg:col-span-4 space-y-10">
                            <div class="bg-white border border-gray-100 rounded-3xl p-8 shadow-xl relative overflow-hidden">
                                <div class="absolute top-0 right-0 w-20 h-20 bg-accent/10 rounded-bl-full"></div>
                                <h3 class="text-xl font-bold text-primary font-serif mb-2 flex items-center gap-2"><i class="ph-fill ph-fire text-accent"></i> Em Alta</h3>
                                <p class="text-sm text-gray-500 mb-6 font-medium">O que a comunidade está debatendo esta semana.</p>
                                
                                <div class="bg-gray-50 p-4 rounded-2xl border border-gray-100 mb-6">
                                    <h4 class="font-bold text-gray-800 text-sm mb-2">"O final de 'Código da Eternidade' foi real?"</h4>
                                    <div class="flex items-center gap-2 text-xs text-gray-400">
                                        <span><i class="ph-fill ph-chat-circle"></i> 45 coments</span>
                                        <span>•</span>
                                        <span>Há 2h</span>
                                    </div>
                                </div>
                                
                                <div id="comment-input-area"></div>
                            </div>

                            <div class="bg-white border border-gray-100 rounded-3xl p-8 shadow-sm">
                                <h4 class="font-bold text-gray-800 mb-6 flex items-center gap-2 text-sm uppercase tracking-wide"><i class="ph-bold ph-chats text-blue-500"></i> Últimas Interações</h4>
                                <div id="sidebar-comments" class="space-y-6"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `,

            about: `
                <div class="animate-fade-in pb-20">
                    <div class="text-center mb-16 pt-10">
                        <h2 class="text-5xl md:text-6xl font-black text-primary mb-4 font-serif">Quem escreve?</h2>
                        <p id="author-role-display" class="text-gray-500 text-lg">Um pouco da loucura por trás dos livros.</p>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 items-start">
                        
                        <div class="relative group cursor-pointer">
                            <img id="about-main-img" src="" class="rounded-2xl shadow-2xl w-full object-cover h-[600px] grayscale group-hover:grayscale-0 transition duration-700">
                            
                            <div class="absolute -bottom-10 -right-5 md:-right-10 w-64 polaroid bg-white p-3 pb-12 shadow-2xl rounded transform rotate-3 group-hover:rotate-6 transition duration-500 z-20">
                                <div class="tape -top-3 left-1/2 -translate-x-1/2"></div>
                                <img id="about-sec-img" src="" class="w-full h-48 object-cover rounded-sm mb-2 shadow-inner">
                                <p id="about-sec-caption" class="text-center font-hand text-2xl text-gray-700 -rotate-1 text-shadow-sm"></p>
                            </div>
                        </div>

                        <div class="space-y-10 pt-10">
                            <div>
                                <h3 id="about-name-display" class="text-3xl font-bold text-primary font-serif mb-6"></h3>
                                <div id="about-bio-display" class="prose text-gray-600 leading-loose text-lg text-justify"></div>
                            </div>

                            <div>
                                <h4 class="font-bold text-accent uppercase tracking-widest text-xs mb-6">Minha Jornada</h4>
                                <div id="about-timeline-list" class="border-l-2 border-gray-200 pl-8 space-y-10 mt-4 relative">
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            `,
            login: `
                <div class="flex items-center justify-center min-h-[60vh] animate-fade-in">
                    <div class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-md border border-gray-100 relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-primary to-accent"></div>
                        <div class="text-center mb-8">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-primary text-3xl"><i class="ph-fill ph-lock-key"></i></div>
                            <h2 class="text-2xl font-bold text-primary font-serif">Acesso Restrito</h2>
                        </div>
                        <form onsubmit="event.preventDefault(); window.app.handleLogin()">
                            <div class="space-y-4">
                                <input type="email" id="email" placeholder="E-mail" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 form-input" value="admin@ronaldo.com">
                                <input type="password" id="password" placeholder="Senha" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 form-input" value="admin">
                                <button class="w-full bg-primary text-white font-bold py-3 rounded-lg hover:bg-accent transition shadow-lg">Entrar no Painel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `,    

            dashboard: `
                <div class="animate-fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-3xl font-bold text-primary font-serif">Painel do Escritor</h2>
                            <p class="text-gray-500">Gestão completa de Produtos e Serviços.</p>
                        </div>
                        <div class="flex gap-3 w-full md:w-auto">
                            <button onclick="window.app.openAboutConfigModal()" class="flex-1 md:flex-none flex items-center justify-center gap-2 bg-white border border-gray-200 text-primary px-5 py-2.5 rounded-lg hover:border-accent hover:text-accent transition font-bold text-sm shadow-sm"><i class="ph-bold ph-user-gear"></i> Editar Bio</button>
                            <button onclick="window.app.openHomeConfigModal()" class="flex-1 md:flex-none flex items-center justify-center gap-2 bg-gradient-to-r from-primary to-slate-800 text-white px-5 py-2.5 rounded-lg hover:shadow-lg hover:-translate-y-0.5 transition font-bold text-sm"><i class="ph-bold ph-house-line"></i> Personalizar Home</button>
                            
                            <button onclick="window.app.setAdminTab('config')" class="flex items-center justify-center w-10 h-10 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 hover:text-primary transition" title="Configurações do Sistema"><i class="ph-bold ph-gear"></i></button>
                            
                            <button onclick="window.app.logout()" class="flex items-center gap-2 bg-red-50 text-red-600 px-4 py-2 rounded-lg hover:bg-red-100 transition font-bold text-sm"><i class="ph ph-sign-out"></i></button>
                        </div>
                    </div>

                    <div class="flex gap-6 border-b border-gray-200 mb-8 overflow-x-auto">
                        <button onclick="window.app.setAdminTab('main')" id="tab-main" class="pb-3 text-sm font-bold border-b-2 border-accent text-accent transition whitespace-nowrap">Visão Geral & Cruds</button>
                        <button onclick="window.app.setAdminTab('analytics')" id="tab-analytics" class="pb-3 text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-primary transition whitespace-nowrap">Relatórios</button>
                        <button onclick="window.app.setAdminTab('leads')" id="tab-leads" class="pb-3 text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-primary transition flex items-center gap-2 whitespace-nowrap">Solicitações <span id="badge-leads" class="bg-red-500 text-white text-[10px] px-1.5 rounded-full hidden">0</span></button>
                        <button onclick="window.app.setAdminTab('community')" id="tab-community" class="pb-3 text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-primary transition whitespace-nowrap flex items-center gap-2"><i class="ph-bold ph-chats-circle"></i> Comunidade</button>
                    </div>

                    <div id="dashboard-content"></div>
                    <div class="h-20"></div>
                </div>
            `,
        
        };

        // ==========================================
        // 2. DADOS & ESTADO
        // ==========================================
        const DB = {
            leads: [],
            systemConfig: {
                maxActiveProjects: 4,
                enableNotifications: true,
                autoReply: false,
                currency: 'BRL',
                adminName: 'Ronaldo Pereira'
            },
            stats: {
                totalVisits: 15420,
                clicksAmazon: 842,
                clicksML: 320,
                clicksShopee: 510,
                mostViewedBook: "O Código da Eternidade",
                monthlyRevenue: [1200, 1500, 1100, 1800, 2200, 14502]
            },
            homeConfig: {
                    heroBookId: '1',
                    showLaunchBadge: true,
                    highlights: ['1', 'S3'],
                    quote: {
                        text: "Escrever é a única forma que encontrei de viver mil vidas em uma só. E convido você a viver elas comigo.",
                        author: "Ronaldo Pereira"
                    }
                },
            author: { 
                name: "Ronaldo Pereira", 
                role: "Escritor de Ficção Especulativa", 
                avatar: "https://placehold.co/600x800/1e293b/FFF?text=Autor+Pro",
                bio: "Olá! Sou o Ronaldo. Minha jornada começou devorando livros na biblioteca. Hoje, dedico minha vida a criar histórias que misturam tecnologia, magia e a complexidade humana.",
                secondaryImage: "https://placehold.co/300x300/d97706/FFF?text=Família",
                secondaryCaption: "Meu porto seguro ❤️",
                timeline: [
                    { year: "2015", title: "O Início", desc: "Publiquei meu primeiro conto em um blog gratuito." },
                    { year: "2018", title: "Primeiro Prêmio", desc: "Vencedor do concurso nacional de Novos Talentos." },
                    { year: "2025", title: "Carreira Sólida", desc: "Mais de 10 mil cópias vendidas digitalmente." }
                ]
            },
            books: [], 
            services: [
                { 
                    id: 'S1', name: 'Design de Capa', price: 800.00, active: true, isPromotion: false, promoPrice: null, unit: '', 
                    description: 'Capa impactante focada em vendas. Identidade visual completa.',
                    icon: 'ph-paint-brush-broad',
                    theme: 'purple'
                },
                { 
                    id: 'S2', name: 'Revisão Textual', price: 0.05, active: true, isPromotion: true, promoPrice: 0.03, unit: 'p/ palavra', 
                    description: 'Correção ortográfica, gramatical e de coerência.',
                    icon: 'ph-text-aa',
                    theme: 'blue'
                },
                { 
                    id: 'S3', name: 'Mentoria Literária', price: 500.00, active: false, isPromotion: false, promoPrice: null, 
                    description: 'Sessões de 1h30 para desbloquear sua escrita e planejar sua carreira.',
                    icon: 'ph-student',
                    theme: 'orange'
                }
            ],
            posts: [
                            { 
                                id: 1, 
                                title: "Como venci o bloqueio criativo", 
                                date: "10/12/2025", 
                                category: "Escrita", 
                                coverType: 'color', coverColor: '1e293b', coverText: "Bloqueio Criativo", coverTextColor: 'white',
                                image: "https://placehold.co/600x300/1e293b/FFF?text=Bloqueio+Criativo", 
                                content: "O bloqueio criativo é o pesadelo de todo escritor. Neste post, compartilho a técnica Pomodoro que mudou minha rotina. O segredo é não parar de escrever, mesmo que seja ruim.",
                                link: "https://pomofocus.io",
                                allowLikes: true, allowComments: true, status: 'published',
                                likes: 142, likedBy: [],
                                comments: [
                                    { id: 101, user: "Carlos M.", avatar: "https://placehold.co/40x40/333/FFF?text=C", text: "Ótima dica!", date: "12/12/2025", likes: 5, likedBy: [], authorLike: true },
                                    { id: 102, user: "Ana Clara", avatar: "https://placehold.co/40x40/555/FFF?text=A", text: "Vou testar hoje.", date: "12/12/2025", likes: 2, likedBy: [], authorLike: false },
                                    { id: 103, user: "Marcos D.", avatar: "https://placehold.co/40x40/444/FFF?text=M", text: "Funciona mesmo?", date: "11/12/2025", likes: 0, likedBy: [], authorLike: false },
                                    { id: 104, user: "Julia S.", avatar: "https://placehold.co/40x40/666/FFF?text=J", text: "Texto incrível!", date: "10/12/2025", likes: 1, likedBy: [], authorLike: false },
                                    { id: 105, user: "Pedro H.", avatar: "https://placehold.co/40x40/777/FFF?text=P", text: "Salvou meu dia.", date: "09/12/2025", likes: 3, likedBy: [], authorLike: false },
                                    { id: 106, user: "Lucas F.", avatar: "https://placehold.co/40x40/888/FFF?text=L", text: "Muito bom.", date: "08/12/2025", likes: 0, likedBy: [], authorLike: false },
                                    { id: 107, user: "Fernanda", avatar: "https://placehold.co/40x40/999/FFF?text=F", text: "Compartilhando...", date: "08/12/2025", likes: 10, likedBy: [], authorLike: true }
                                ]
                            },
                            { 
                                id: 2, 
                                title: "O futuro da Ficção", 
                                date: "12/12/2025", 
                                category: "Opinião", 
                                coverType: 'upload', coverColor: '', coverText: '', coverTextColor: 'black',
                                image: "https://placehold.co/600x300/d97706/FFF?text=Sci-Fi+BR", 
                                content: "A ficção especulativa nacional tem crescido. O que vocês acham do cenário atual?",
                                link: "",
                                allowLikes: true, allowComments: true, status: 'published',
                                likes: 89, likedBy: [],
                                comments: []
                            }
                        ],
            };

        // BIBLIOTECA DE ÍCONES PARA O SELETOR
        const ICON_LIBRARY = [
            'ph-pencil-simple', 'ph-pen-nib', 'ph-book-open', 'ph-book-bookmark', 'ph-notebook',
            'ph-magic-wand', 'ph-sparkle', 'ph-star', 'ph-crown', 'ph-medal',
            'ph-lightbulb', 'ph-lightning', 'ph-fire', 'ph-rocket', 'ph-airplane-tilt',
            'ph-chat-circle-text', 'ph-quotes', 'ph-translate', 'ph-microphone', 'ph-video-camera',
            'ph-user', 'ph-users', 'ph-student', 'ph-chalkboard-teacher', 'ph-briefcase',
            'ph-paint-brush', 'ph-palette', 'ph-image', 'ph-camera', 'ph-crop',
            'ph-check-circle', 'ph-shield-check', 'ph-lock-key', 'ph-key', 'ph-fingerprint',
            'ph-chart-line-up', 'ph-target', 'ph-trophy', 'ph-money', 'ph-credit-card'
        ];

        // DEFINIÇÃO DE TEMAS (Visualmente agradáveis e acessíveis)
        const THEMES = {
            'default': { name: 'Midnight', bg: 'bg-slate-50', border: 'border-slate-200', text: 'text-slate-700', dot: 'bg-slate-800' },
            'orange':  { name: 'Sunset',   bg: 'bg-orange-50', border: 'border-orange-200', text: 'text-orange-800', dot: 'bg-orange-500' },
            'blue':    { name: 'Ocean',    bg: 'bg-blue-50',   border: 'border-blue-200',   text: 'text-blue-800',   dot: 'bg-blue-600' },
            'purple':  { name: 'Royal',    bg: 'bg-purple-50', border: 'border-purple-200', text: 'text-purple-800', dot: 'bg-purple-600' },
            'green':   { name: 'Forest',   bg: 'bg-emerald-50', border: 'border-emerald-200', text: 'text-emerald-800', dot: 'bg-emerald-600' },
            'red':     { name: 'Passion',  bg: 'bg-rose-50',    border: 'border-rose-200',    text: 'text-rose-800',    dot: 'bg-rose-600' },
        };

        // Gerador de Livros Mock   
        function generateBooks() { /* ...seu código atual... */ 
             const covers = ['1e293b', 'd97706', '475569', '0f766e', 'be123c', '4338ca'];
             const genres = ['Ficção', 'Fantasia', 'Thriller'];
             for(let i=1; i<=6; i++) {
                DB.books.push({id: i.toString(), title: `Livro Vol.${i}`, genre: genres[i%3], price: 29.90+(i*2), active: true, isPromotion: i%2===0, promoPrice: 20.00, cover: `https://placehold.co/300x450/${covers[i%6]}/FFF`, synopsis: "Sinopse...", linkAmazon:'#', linkML:'#', linkShopee:'#'});
             }
        }

        function generateServices() {
             DB.services = [
                { id: 'S1', name: 'Design de Capa', price: 800, active: true, isPromotion: false, icon: 'ph-paint-brush-broad', theme: 'purple', description: 'Capa impactante.' },
                { id: 'S2', name: 'Revisão', price: 0.05, unit: 'p/ palavra', active: true, isPromotion: true, promoPrice: 0.03, icon: 'ph-text-aa', theme: 'blue', description: 'Revisão.' },
                { id: 'S3', name: 'Mentoria', price: 500, active: false, icon: 'ph-student', theme: 'orange', description: 'Aulas.' }
             ];
        }

        function generateMockLeads() {
            const names = ["Fernanda Costa", "Roberto Silva", "Ana Souza", "Carlos Lima", "Beatriz Melo"];
            const emails = ["fer.costa@email.com", "beto@email.com", "ana.souza@email.com", "carlos@l.com", "bia@m.com"];
            const services = ["Mentoria Literária", "Design de Capa", "Revisão Textual"];
            const prices = { "Mentoria Literária": 500, "Design de Capa": 800, "Revisão Textual": 350 }; 
            const statuses = ['pending', 'analyzing', 'working', 'finished', 'cancelled'];
            
            for(let i=0; i<45; i++) {
                const randIndex = Math.floor(Math.random() * names.length);
                const sName = services[Math.floor(Math.random() * services.length)];
                const daysAgo = Math.floor(Math.random() * 90);
                const date = new Date();
                date.setDate(date.getDate() - daysAgo);
                
                // Gera um telefone aleatório formato BR
                const phone = `(11) 9${Math.floor(Math.random() * 9000 + 1000)}-${Math.floor(Math.random() * 9000 + 1000)}`;

                DB.leads.push({
                    id: 1765571805000 + i,
                    name: names[randIndex],
                    email: emails[randIndex],
                    phone: phone, // NOVO CAMPO
                    service: sName,
                    value: prices[sName],
                    desc: `Solicitação nº ${i}. Gostaria de um orçamento detalhado para meu livro de 300 páginas.`,
                    date: date.toLocaleDateString('pt-BR'),
                    timestamp: date.getTime(),
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    notes: "" 
                });
            }
            DB.leads.sort((a, b) => b.timestamp - a.timestamp);
        }

        generateBooks();
        generateServices();
        generateMockLeads();

        const adminState = {
            currentTab: 'main', 
            books: { page: 1, filter: '', sortKey: 'title', sortOrder: 'asc' }, 
            services: { page: 1, filter: '', sortKey: 'name', sortOrder: 'asc' },
            // Garantindo que propriedades de filtro existam
            leads: { page: 1, filterDays: 60, statusFilter: 'all', subTab: 'all', sortOrder: 'desc', searchTerm: '' }, 
            postComments: { page: 1, filterText: '', filterDate: 'all', itemsPerPage: 5 },
            leadModal: { page: 1, itemsPerPage: 5, filterStatus: 'all' },
            itemsPerPage: 5
        };
        
        // Estado para controlar quantos comentários aparecem na área pública (por post)
        const publicState = {
            expandedComments: {} // { postId: 3 (default), 10, 20... }
        };

        
        // ESTADO GLOBAL SIMPLIFICADO
        let favorites = JSON.parse(localStorage.getItem('user_favorites')) || []; 
        let user = JSON.parse(localStorage.getItem('user')) || null;
        let isAdmin = localStorage.getItem('isAdmin') === 'true';
        let currentPage = 1;
        const itemsPerPage = 6;

        // ==========================================
        // 3. LÓGICA DO APP (ROUTER & CONTROLLERS)
        // ==========================================
        
        function router() {
            const hash = window.location.hash || '#/';
            const app = document.getElementById('app');
            let pageKey = 'home';

            if(hash === '#/') pageKey = 'home';
            else if(hash.startsWith('#/livro/')) pageKey = 'book_details';
            else if(hash.includes('livros')) pageKey = 'livros';
            else if(hash.includes('servicos')) pageKey = 'servicos';
            else if(hash.includes('autor')) pageKey = 'about';
            else if(hash.includes('comunidade')) pageKey = 'community';
            else if(hash.includes('painel')) pageKey = isAdmin ? 'dashboard' : 'login';

            app.innerHTML = TEMPLATES[pageKey];
            window.scrollTo(0, 0);
            
            if(pageKey === 'home') initHome();
            if(pageKey === 'livros') { currentPage = 1; initLivros(); }
            if(pageKey === 'book_details') { const id = hash.split('/')[2]; initBookDetails(id); }
            if(pageKey === 'servicos') initServicos();
            if(pageKey === 'about') initAbout();
            if(pageKey === 'community') initCommunity();
            if(pageKey === 'dashboard') initDashboard();
            
            const menu = document.getElementById('mobile-menu');
            if(menu) menu.classList.add('hidden');
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const color = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            const icon = type === 'success' ? 'ph-check-circle' : 'ph-warning-circle';
            toast.className = `${color} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 transform translate-x-full transition-all duration-500 pointer-events-auto min-w-[300px]`;
            toast.innerHTML = `<i class="ph-fill ${icon} text-xl"></i> <span class="font-bold text-sm">${message}</span>`;
            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.remove('translate-x-full'));
            setTimeout(() => { toast.classList.add('opacity-0', 'translate-x-full'); setTimeout(() => toast.remove(), 500); }, 3000);
        }

        // --- CONTROLLERS ---

        // Substitua a função initBookDetails atual por esta:
        function initBookDetails(id) {
            const book = DB.books.find(b => b.id === id);
            if(!book) { window.location.hash = '#/livros'; return; }
            
            // Dados Básicos
            document.getElementById('detail-img').src = book.cover;
            document.getElementById('detail-title').innerText = book.title;
            document.getElementById('detail-genre').innerText = book.genre;
            
            // Sinopse
            const synopsisContainer = document.querySelector('.prose');
            if(synopsisContainer) {
                synopsisContainer.innerHTML = (book.synopsis || '').split('\n').map(p => `<p>${p}</p>`).join('');
            }

            // Lógica de Preço e Promoção
            const promoBadge = document.querySelector('.absolute.top-5.right-5');
            const promoBanner = document.querySelector('.bg-gradient-to-r.from-orange-100');
            const priceContainer = document.getElementById('detail-price').parentNode;

            if (book.isPromotion && book.promoPrice) {
                if(promoBadge) promoBadge.classList.remove('hidden');
                if(promoBanner) promoBanner.classList.remove('hidden');
                
                // Exibe Preço Promocional Grande e o Original riscado
                const discount = Math.round(((book.price - book.promoPrice) / book.price) * 100);
                priceContainer.innerHTML = `
                    <div class="text-4xl font-black text-primary" id="detail-price">R$ ${book.promoPrice.toFixed(2)}</div>
                    <p class="text-sm text-gray-400 pb-2 decoration-slice line-through decoration-red-500 decoration-2">De R$ ${book.price.toFixed(2)}</p>
                    <span class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded mb-2">${discount}% OFF</span>
                `;
            } else {
                if(promoBadge) promoBadge.classList.add('hidden');
                if(promoBanner) promoBanner.classList.add('hidden');
                
                // Exibe apenas preço normal
                priceContainer.innerHTML = `
                    <div class="text-4xl font-black text-primary" id="detail-price">R$ ${book.price.toFixed(2)}</div>
                `;
            }
            
            // Links e Favoritos (Mantido igual)
            document.getElementById('link-amazon').href = book.linkAmazon || '#';
            document.getElementById('link-ml').href = book.linkML || '#';
            document.getElementById('link-shopee').href = book.linkShopee || '#';

            const favBtn = document.getElementById('detail-fav-btn'); 
            const favIcon = document.getElementById('detail-fav-icon');
            const updateState = () => {
                if(favorites.includes(book.id)) {
                    favIcon.className = "ph-fill ph-heart text-xl text-red-500";
                    favIcon.classList.remove('text-gray-300');
                } else {
                    favIcon.className = "ph-fill ph-heart text-xl text-gray-300";
                }
            };
            favBtn.onclick = () => { window.app.toggleFavorite(book.id); updateState(); };
            updateState();
        }

        function initDashboard() {
            const content = document.getElementById('dashboard-content');
            if (!content) return;

            // Gerenciamento de classes das abas (Visual da navegação)
            ['main', 'analytics', 'leads', 'community', 'config'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if (btn) {
                    const isActive = adminState.currentTab === t;
                    // Se o botão for 'leads' ou 'community', adiciona flex para o ícone alinhar
                    const extraClasses = (t === 'leads' || t === 'community') ? " flex items-center gap-2" : "";
                    
                    btn.className = isActive
                        ? "pb-3 text-sm font-bold border-b-2 border-accent text-primary transition whitespace-nowrap" + extraClasses
                        : "pb-3 text-sm font-bold border-b-2 border-transparent text-gray-400 hover:text-primary transition whitespace-nowrap" + extraClasses;
                }
            });

            // Badge Vermelho de Leads Pendentes
            const pendingTotal = DB.leads.filter(l => l.status === 'pending').length;
            const badge = document.getElementById('badge-leads');
            if (badge) {
                badge.innerText = pendingTotal;
                badge.classList.toggle('hidden', pendingTotal === 0);
            }

            // ============================================================
            // ABA 1: VISÃO GERAL (DADOS REAIS CONECTADOS)
            // ============================================================
            if (adminState.currentTab === 'main') {
                const totalBooks = DB.books.length;
                const totalServices = DB.services.filter(s => s.active).length;
                const totalLeads = DB.leads.length;

                content.innerHTML = `
                    <div class="animate-fade-in">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
                            <div class="dashboard-card border-l-4 border-accent">
                                <p class="text-gray-400 text-xs font-bold uppercase tracking-wide mb-1">Livros Publicados</p>
                                <h3 class="text-3xl font-black text-primary">${totalBooks}</h3>
                            </div>
                            <div class="dashboard-card border-l-4 border-blue-500">
                                <p class="text-gray-400 text-xs font-bold uppercase tracking-wide mb-1">Serviços Ativos</p>
                                <h3 class="text-3xl font-black text-primary">${totalServices}</h3>
                            </div>
                            <div class="dashboard-card">
                                <p class="text-gray-400 text-xs font-bold uppercase tracking-wide mb-1">Total de Pedidos</p>
                                <h3 class="text-3xl font-black text-primary">${totalLeads}</h3>
                            </div>
                            <div class="dashboard-card">
                                <p class="text-gray-400 text-xs font-bold uppercase tracking-wide mb-1">Pendências</p>
                                <h3 class="text-3xl font-black text-accent">${pendingTotal}</h3>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-12">
                            <div class="dashboard-card" id="books-table-container"></div>
                            <div class="dashboard-card border-t-4 border-blue-500" id="services-table-container"></div>
                        </div>
                    </div>`;
                
                document.getElementById('books-table-container').innerHTML = getBooksTableHTML();
                document.getElementById('services-table-container').innerHTML = getServicesTableHTML();
                renderBooksTableRows();
                renderServicesTableRows();

            // ============================================================
            // ABA 2: RELATÓRIOS (CÁLCULOS DINÂMICOS)
            // ============================================================
            } else if (adminState.currentTab === 'analytics') {
                // 1. Cliques Totais
                const totalClicks = DB.stats.clicksAmazon + DB.stats.clicksML + DB.stats.clicksShopee;
                
                // 2. Ranking de Serviços (Top 3)
                const serviceCounts = {};
                DB.leads.forEach(l => { serviceCounts[l.service] = (serviceCounts[l.service] || 0) + 1; });
                const sortedServices = Object.entries(serviceCounts).sort((a, b) => b[1] - a[1]).slice(0, 3);

                // 3. Funil de Status
                const statusCounts = { pending: 0, working: 0, finished: 0 };
                DB.leads.forEach(l => {
                    if(statusCounts[l.status] !== undefined) statusCounts[l.status]++;
                });

                content.innerHTML = `
                    <div class="animate-fade-in space-y-8">
                        <div class="flex justify-between items-center">
                            <h3 class="text-2xl font-bold text-primary font-serif">Performance do Autor</h3>
                            <button onclick="window.app.exportMetricsCsv()" class="bg-white border border-gray-200 text-gray-700 hover:text-primary px-4 py-2 rounded-lg text-xs font-bold shadow-sm flex items-center gap-2 transition hover:bg-gray-50">
                                <i class="ph-bold ph-download-simple"></i> Exportar CSV
                            </button>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-primary text-white p-6 rounded-2xl shadow-lg relative overflow-hidden">
                                <div class="relative z-10">
                                    <p class="text-slate-400 text-xs font-bold uppercase mb-2">Interesse de Compra</p>
                                    <h3 class="text-4xl font-black text-accent">${totalClicks}</h3>
                                    <p class="text-xs text-slate-400 mt-2">Cliques em links externos</p>
                                </div>
                                <i class="ph-fill ph-cursor-click absolute -right-4 -bottom-4 text-9xl text-white opacity-5"></i>
                            </div>

                            <div class="bg-white border border-gray-200 p-6 rounded-2xl shadow-sm">
                                <p class="text-gray-400 text-xs font-bold uppercase mb-4">Funil de Atendimento</p>
                                <div class="space-y-3">
                                    <div class="flex justify-between text-xs font-bold text-gray-600"><span>Pendentes</span> <span>${statusCounts.pending}</span></div>
                                    <div class="w-full bg-gray-100 h-1.5 rounded-full mb-2"><div class="bg-yellow-400 h-full rounded-full" style="width: ${(statusCounts.pending/DB.leads.length*100)||0}%"></div></div>
                                    
                                    <div class="flex justify-between text-xs font-bold text-gray-600"><span>Em Produção</span> <span>${statusCounts.working}</span></div>
                                    <div class="w-full bg-gray-100 h-1.5 rounded-full mb-2"><div class="bg-blue-500 h-full rounded-full" style="width: ${(statusCounts.working/DB.leads.length*100)||0}%"></div></div>

                                    <div class="flex justify-between text-xs font-bold text-gray-600"><span>Finalizados</span> <span>${statusCounts.finished}</span></div>
                                    <div class="w-full bg-gray-100 h-1.5 rounded-full"><div class="bg-green-500 h-full rounded-full" style="width: ${(statusCounts.finished/DB.leads.length*100)||0}%"></div></div>
                                </div>
                            </div>

                            <div class="bg-gradient-to-br from-purple-600 to-indigo-700 text-white p-6 rounded-2xl shadow-lg relative overflow-hidden">
                                <div class="relative z-10">
                                    <p class="text-purple-200 text-xs font-bold uppercase mb-4">Serviços + Populares</p>
                                    <ul class="space-y-3">
                                        ${sortedServices.map((s, i) => `
                                            <li class="flex items-center justify-between text-sm font-bold border-b border-white/10 pb-2">
                                                <span>${i+1}. ${s[0]}</span>
                                                <span class="bg-white/20 px-2 py-0.5 rounded text-xs">${s[1]}</span>
                                            </li>
                                        `).join('') || '<li class="text-xs opacity-50">Sem dados suficientes.</li>'}
                                    </ul>
                                </div>
                                <i class="ph-fill ph-chart-bar absolute -right-4 -bottom-4 text-9xl text-white opacity-10"></i>
                            </div>
                        </div>

                        <div class="bg-white p-8 rounded-2xl border border-gray-200 shadow-sm">
                            <h3 class="font-bold text-lg text-primary mb-6">Origem do Tráfego (Links)</h3>
                            <div class="space-y-6">
                                <div><div class="flex justify-between text-xs font-bold mb-2"><span>Amazon</span><span>${DB.stats.clicksAmazon}</span></div><div class="w-full bg-gray-50 h-2 rounded-full"><div class="bg-[#FF9900] h-full rounded-full" style="width: ${(DB.stats.clicksAmazon/totalClicks*100)||0}%"></div></div></div>
                                <div><div class="flex justify-between text-xs font-bold mb-2"><span>Mercado Livre</span><span>${DB.stats.clicksML}</span></div><div class="w-full bg-gray-50 h-2 rounded-full"><div class="bg-[#FFE600] h-full rounded-full" style="width: ${(DB.stats.clicksML/totalClicks*100)||0}%"></div></div></div>
                                <div><div class="flex justify-between text-xs font-bold mb-2"><span>Shopee</span><span>${DB.stats.clicksShopee}</span></div><div class="w-full bg-gray-50 h-2 rounded-full"><div class="bg-[#EE4D2D] h-full rounded-full" style="width: ${(DB.stats.clicksShopee/totalClicks*100)||0}%"></div></div></div>
                            </div>
                        </div>
                    </div>`;

            // ============================================================
            // ABA 3: SOLICITAÇÕES (CRM AVANÇADO)
            // ============================================================
            } else if (adminState.currentTab === 'leads') {
                const now = new Date();
                const cutoff = new Date();
                cutoff.setDate(now.getDate() - adminState.leads.filterDays);
                
                // --- NOVOS KPIs DO TOPO ---
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
                const kpiNew = DB.leads.filter(l => l.timestamp >= startOfMonth).length;
                const kpiResolved = DB.leads.filter(l => l.status === 'finished').length;
                const kpiPending = DB.leads.filter(l => l.status === 'pending').length;

                // 1. Agrupamento por Email (Cliente)
                const groupedMap = new Map();
                DB.leads.forEach(lead => {
                    if (!groupedMap.has(lead.email)) {
                        groupedMap.set(lead.email, {
                            clientName: lead.name,
                            email: lead.email,
                            items: [],
                            stats: { total: 0, resolved: 0, active: 0, pending: 0 }
                        });
                    }
                    const group = groupedMap.get(lead.email);
                    group.items.push(lead);
                    
                    group.stats.total++;
                    if (['finished', 'cancelled'].includes(lead.status)) group.stats.resolved++;
                    else if (['working', 'analyzing'].includes(lead.status)) group.stats.active++;
                    else group.stats.pending++;
                });

                // 2. Filtragem
                let filteredGroups = Array.from(groupedMap.values()).filter(g => {
                    const hasRecent = adminState.leads.filterDays === 'all' || g.items.some(i => new Date(i.timestamp) >= cutoff);
                    if (!hasRecent) return false;

                    const tab = adminState.leads.subTab;
                    if (tab === 'active' && g.stats.active === 0 && g.stats.pending === 0) return false;
                    if (tab === 'finished' && (g.stats.active > 0 || g.stats.pending > 0)) return false;

                    const search = (adminState.leads.searchTerm || '').toLowerCase();
                    if (search) {
                        return g.clientName.toLowerCase().includes(search) || 
                            g.email.toLowerCase().includes(search) || 
                            g.items.some(i => i.id.toString().includes(search));
                    }
                    return true;
                });
                
                // 3. Ordenação
                filteredGroups.sort((a, b) => {
                    const dateA = Math.max(...a.items.map(i => i.timestamp));
                    const dateB = Math.max(...b.items.map(i => i.timestamp));
                    return adminState.leads.sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
                });

                // 4. Paginação e Renderização
                const totalGroupsCount = filteredGroups.length;
                const startL = (adminState.leads.page - 1) * adminState.itemsPerPage;
                const pagedGroups = filteredGroups.slice(startL, startL + adminState.itemsPerPage);

                const listHTML = pagedGroups.map(group => {
                    const latestLead = group.items[0]; 
                    const isFullyResolved = group.stats.total === group.stats.resolved;
                    const progress = (group.stats.resolved / group.stats.total) * 100;
                    
                    let borderClass = 'border-l-4 border-blue-500';
                    if(isFullyResolved) borderClass = 'border-l-4 border-green-500 bg-green-50/20';
                    else if(group.stats.pending > 0 && group.stats.active === 0) borderClass = 'border-l-4 border-red-500';

                    return `
                        <div onclick="window.app.openLeadModal('${group.email}')" class="bg-white rounded-xl shadow-sm border border-gray-200 p-5 hover:shadow-md transition-all cursor-pointer group relative ${borderClass}">
                            ${isFullyResolved ? '<div class="absolute top-4 right-4 text-green-500"><i class="ph-fill ph-check-circle text-2xl"></i></div>' : ''}
                            <div class="flex flex-col md:flex-row gap-4 items-start">
                                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-primary to-slate-700 flex items-center justify-center font-bold text-white text-lg shrink-0">${group.clientName.charAt(0)}</div>
                                <div class="flex-1 w-full">
                                    <h4 class="font-bold text-gray-800 text-lg group-hover:text-primary transition flex items-center gap-2">${group.clientName} <span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded border border-gray-200">ID Ref: #${latestLead.id}</span></h4>
                                    <span class="text-xs text-gray-400 font-mono">${group.email}</span>
                                    <div class="mt-4">
                                        <div class="flex justify-between text-xs mb-1 font-bold"><span class="${isFullyResolved ? 'text-green-600' : 'text-gray-500'}">${isFullyResolved ? 'Resolvido' : `${group.stats.active} Atuando • ${group.stats.pending} Pendentes`}</span><span class="text-gray-400">${group.stats.resolved}/${group.stats.total}</span></div>
                                        <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden"><div class="h-full ${isFullyResolved ? 'bg-green-500' : 'bg-blue-500'} transition-all duration-500" style="width: ${progress}%"></div></div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }).join('');

                content.innerHTML = `
                    <div class="animate-fade-in">
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="bg-white border border-gray-200 rounded-xl p-4 flex flex-col items-center justify-center shadow-sm">
                                <span class="text-3xl font-black text-accent">${kpiPending}</span>
                                <span class="text-[10px] font-bold text-gray-400 uppercase">Pendentes</span>
                            </div>
                            <div class="bg-white border border-gray-200 rounded-xl p-4 flex flex-col items-center justify-center shadow-sm">
                                <span class="text-3xl font-black text-green-600">${kpiResolved}</span>
                                <span class="text-[10px] font-bold text-gray-400 uppercase">Resolvidos</span>
                            </div>
                            <div class="bg-white border border-gray-200 rounded-xl p-4 flex flex-col items-center justify-center shadow-sm">
                                <span class="text-3xl font-black text-blue-600">+${kpiNew}</span>
                                <span class="text-[10px] font-bold text-gray-400 uppercase">Novos (Mês)</span>
                            </div>
                        </div>

                        <div class="bg-white p-2 rounded-xl border border-gray-200 shadow-sm mb-6 flex flex-col xl:flex-row justify-between items-center gap-4">
                            <div class="flex p-1 bg-gray-100 rounded-lg shrink-0 overflow-x-auto">
                                <button onclick="window.app.setLeadSubTab('all')" class="px-4 py-2 rounded-md text-xs font-bold transition whitespace-nowrap ${adminState.leads.subTab === 'all' ? 'bg-white text-primary shadow-sm' : 'text-gray-500 hover:text-gray-700'}">Visão Geral</button>
                                <button onclick="window.app.setLeadSubTab('active')" class="px-4 py-2 rounded-md text-xs font-bold transition whitespace-nowrap ${adminState.leads.subTab === 'active' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}">Em Atuação</button>
                                <button onclick="window.app.setLeadSubTab('finished')" class="px-4 py-2 rounded-md text-xs font-bold transition whitespace-nowrap ${adminState.leads.subTab === 'finished' ? 'bg-white text-green-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}">Finalizados</button>
                            </div>
                            <div class="flex gap-2 w-full xl:w-auto">
                                <div class="relative flex-1 xl:w-64">
                                    <i class="ph-bold ph-magnifying-glass absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                                    <input type="text" placeholder="Buscar ID, Nome ou Email..." oninput="window.app.setLeadSearch(this.value)" value="${adminState.leads.searchTerm || ''}" class="w-full bg-gray-50 border border-gray-200 rounded-lg pl-8 p-2 text-xs focus:outline-none focus:border-accent font-bold text-gray-700">
                                </div>
                                <select onchange="window.app.setLeadSort(this.value)" class="bg-gray-50 border border-gray-200 text-xs font-bold text-gray-600 rounded-lg p-2 outline-none">
                                    <option value="desc" ${adminState.leads.sortOrder === 'desc' ? 'selected' : ''}>Mais Recentes</option>
                                    <option value="asc" ${adminState.leads.sortOrder === 'asc' ? 'selected' : ''}>Mais Antigos</option>
                                </select>
                            </div>
                        </div>

                        <div class="space-y-4">
                            ${listHTML || '<div class="text-center py-16 bg-gray-50 rounded-2xl border border-dashed border-gray-200"><p class="text-gray-500 font-bold">Nenhum cliente encontrado.</p></div>'}
                        </div>
                        
                        <div class="flex justify-center items-center gap-3 mt-8">
                            <button onclick="window.app.changeLeadsPage(-1)" class="w-10 h-10 rounded border hover:bg-gray-100 flex items-center justify-center disabled:opacity-50" ${adminState.leads.page === 1 ? 'disabled' : ''}><i class="ph-bold ph-caret-left"></i></button>
                            <span class="text-xs font-bold text-gray-500">Pág ${adminState.leads.page} de ${Math.ceil(totalGroupsCount/adminState.itemsPerPage) || 1}</span>
                            <button onclick="window.app.changeLeadsPage(1)" class="w-10 h-10 rounded border hover:bg-gray-100 flex items-center justify-center disabled:opacity-50" ${adminState.leads.page >= Math.ceil(totalGroupsCount/adminState.itemsPerPage) ? 'disabled' : ''}><i class="ph-bold ph-caret-right"></i></button>
                        </div>
                    </div>`;

            // ============================================================
            // ABA 4: COMUNIDADE (CORRIGIDO - VOLTOU A FUNCIONAR)
            // ============================================================
            } else if (adminState.currentTab === 'community') {
                const posts = DB.posts;
                content.innerHTML = `
                    <div class="animate-fade-in">
                        <div class="flex justify-between items-end mb-8">
                            <div><h3 class="text-2xl font-bold text-primary font-serif">Gestão de Comunidade</h3><p class="text-gray-500 text-sm">Gerencie artigos e comentários.</p></div>
                            <button onclick="window.app.openPostModal()" class="bg-primary hover:bg-slate-800 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition flex items-center gap-2"><i class="ph-bold ph-pen-nib"></i> Escrever Novo</button>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 h-[calc(100vh-250px)]">
                            <div class="lg:col-span-1 bg-white border border-gray-200 rounded-2xl flex flex-col overflow-hidden shadow-sm">
                                <div class="p-4 border-b border-gray-100 bg-gray-50"><span class="text-xs font-bold text-gray-400 uppercase">Seus Artigos (${posts.length})</span></div>
                                <div class="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-2">
                                    ${posts.map(p => `
                                        <div onclick="window.app.selectAdminPost(${p.id})" class="p-4 rounded-xl cursor-pointer transition border border-transparent hover:border-gray-200 hover:bg-gray-50 group ${window.app.selectedPostId === p.id ? 'bg-blue-50 border-blue-100 ring-1 ring-blue-200' : 'bg-white'}">
                                            <div class="flex gap-3"><img src="${p.image}" class="w-16 h-16 rounded-lg object-cover flex-shrink-0"><div class="flex-1 min-w-0"><h4 class="font-bold text-gray-800 text-sm truncate mb-1">${p.title}</h4><span class="text-[10px] text-gray-400">${p.date} • ${p.likes} Likes</span></div></div>
                                        </div>`).join('')}
                                </div>
                            </div>
                            <div class="lg:col-span-2 bg-gray-50 border border-gray-200 rounded-2xl p-8 relative flex flex-col justify-center items-center text-center" id="admin-post-detail">
                                <div class="text-gray-400"><i class="ph-duotone ph-article text-6xl mb-4"></i><p>Selecione um artigo.</p></div>
                            </div>
                        </div>
                    </div>`;
                if(window.app.selectedPostId) window.app.renderAdminPostDetail(window.app.selectedPostId);

            // ============================================================
            // ABA 5: CONFIGURAÇÕES
            // ============================================================
            } else if (adminState.currentTab === 'config') {
                const conf = DB.systemConfig;
                content.innerHTML = `
                    <div class="animate-fade-in max-w-4xl mx-auto">
                        <div class="mb-8"><h3 class="text-2xl font-bold text-primary font-serif">Configurações do Sistema</h3><p class="text-gray-500 text-sm">Ajustes globais.</p></div>
                        <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm mb-8">
                            <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="ph-fill ph-briefcase text-blue-500"></i> Fluxo de Trabalho</h4>
                            <div class="space-y-6">
                                <div>
                                    <label class="text-xs font-bold text-gray-500 uppercase block mb-2">Limite de Projetos</label>
                                    <div class="flex items-center gap-4"><input type="range" min="1" max="20" value="${conf.maxActiveProjects}" oninput="document.getElementById('range-val').innerText = this.value" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"><span id="range-val" class="font-bold text-xl text-blue-600 w-8 text-center">${conf.maxActiveProjects}</span></div>
                                </div>
                                <div class="flex items-center justify-between"><div><span class="text-sm font-bold text-gray-700 block">Resposta Automática</span><span class="text-xs text-gray-400">Enviar e-mail ao lead?</span></div><input type="checkbox" ${conf.autoReply ? 'checked' : ''} class="accent-blue-600 w-5 h-5"></div>
                            </div>
                        </div>
                        <div class="text-right"><button onclick="window.app.toast('Configurações salvas!', 'success')" class="bg-primary hover:bg-slate-800 text-white px-8 py-3 rounded-xl font-bold shadow-lg transition">Salvar Alterações</button></div>
                    </div>`;
            }
        }
        
        function renderBooksTable() {
            // 1. Filtra e Ordena
            let list = DB.books.filter(b => b.title.toLowerCase().includes(adminState.books.filter.toLowerCase()));
            list.sort((a, b) => {
                let vA = a[adminState.books.sortKey], vB = b[adminState.books.sortKey];
                if (typeof vA === 'string') vA = vA.toLowerCase(); if (typeof vB === 'string') vB = vB.toLowerCase();
                if (vA < vB) return adminState.books.sortOrder === 'asc' ? -1 : 1; if (vA > vB) return adminState.books.sortOrder === 'asc' ? 1 : -1; return 0;
            });

            // 2. Pagina
            const start = (adminState.books.page - 1) * adminState.itemsPerPage;
            const paged = list.slice(start, start + adminState.itemsPerPage);

            // 3. Injeta no HTML (COM O DESIGN RECUPERADO)
            const tbody = document.getElementById('admin-books-table');
            if (tbody) {
                if(paged.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-400">Nenhum livro encontrado.</td></tr>`;
                } else {
                    tbody.innerHTML = paged.map(b => `
                        <tr class="border-b border-gray-100 hover:bg-gray-50 transition group ${b.active ? '' : 'opacity-60 bg-gray-50'}">
                            <td class="p-3"><img src="${b.cover}" class="w-10 h-14 object-cover rounded shadow-sm"></td>
                            <td class="p-3 font-bold text-primary">${b.title}</td>
                            <td class="p-3 text-gray-500">
                                ${b.isPromotion && b.promoPrice ? 
                                    `<div class="flex flex-col"><span class="line-through text-xs text-gray-400">R$ ${b.price.toFixed(2)}</span><span class="text-green-600 font-bold">R$ ${b.promoPrice.toFixed(2)}</span></div>` : 
                                    `R$ ${b.price.toFixed(2)}`
                                }
                            </td>
                            <td class="p-3 text-center">
                                ${b.isPromotion ? 
                                    '<span class="text-[10px] bg-orange-50 text-orange-700 border border-orange-200 px-2 py-0.5 rounded font-bold">SIM</span>' : 
                                    '<span class="text-[10px] text-gray-300">-</span>'
                                }
                            </td>
                            <td class="p-3 text-center">
                                <span class="inline-flex items-center gap-1.5 text-xs font-bold px-2 py-1 rounded-full ${b.active ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-gray-100 text-gray-500 border border-gray-200'}">
                                    <span class="w-1.5 h-1.5 rounded-full ${b.active ? 'bg-green-500' : 'bg-gray-400'}"></span>
                                    ${b.active ? 'Ativo' : 'Inativo'}
                                </span>
                            </td>
                            <td class="p-3 text-right">
                                <button onclick="window.app.openBookModal('${b.id}')" class="text-blue-500 hover:bg-blue-50 p-2 rounded-full transition"><i class="ph-bold ph-pencil-simple"></i></button>
                                <button onclick="window.app.deleteBook('${b.id}')" class="text-red-400 hover:bg-red-50 p-2 rounded-full transition"><i class="ph-bold ph-trash"></i></button>
                            </td>
                        </tr>`).join('');
                }
                document.getElementById('admin-books-info').innerText = `Mostrando ${paged.length} de ${list.length}`;
            }
        }

        function renderServicesTable() {
            // 1. Filtro e Ordenação
            let list = DB.services.filter(s => s.name.toLowerCase().includes(adminState.services.filter.toLowerCase()));
            list.sort((a, b) => {
                let vA = a[adminState.services.sortKey], vB = b[adminState.services.sortKey];
                if (typeof vA === 'string') vA = vA.toLowerCase(); if (typeof vB === 'string') vB = vB.toLowerCase();
                if (vA < vB) return adminState.services.sortOrder === 'asc' ? -1 : 1; if (vA > vB) return adminState.services.sortOrder === 'asc' ? 1 : -1; return 0;
            });

            // 2. Paginação
            const start = (adminState.services.page - 1) * adminState.itemsPerPage;
            const paged = list.slice(start, start + adminState.itemsPerPage);
            const tbody = document.getElementById('admin-services-table');

            if (tbody) {
                if(paged.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400">Nenhum serviço encontrado.</td></tr>`;
                } else {
                    tbody.innerHTML = paged.map(s => {
                        // RECUPERA O TEMA (Roxo, Laranja, Azul...) PARA USAR NAS CORES
                        const theme = THEMES[s.theme || 'default'];
                        
                        return `
                        <tr class="border-b ${theme.border} ${s.active ? theme.bg : 'bg-gray-50 opacity-60'} hover:brightness-95 transition">
                            
                            <td class="p-3">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-lg bg-white/60 flex items-center justify-center shadow-sm text-xl ${theme.text}">
                                        <i class="ph-fill ${s.icon || 'ph-star-four'}"></i>
                                    </div>
                                    <div>
                                        <div class="font-bold text-gray-800">${s.name}</div>
                                        <div class="text-xs ${theme.text} opacity-80 truncate max-w-[150px]">${s.description}</div>
                                    </div>
                                </div>
                            </td>

                            <td class="p-3 font-mono text-sm ${theme.text}">
                                <div class="flex flex-col">
                                    ${s.isPromotion && s.promoPrice ? 
                                        `<span class="line-through text-xs opacity-50">R$ ${s.price.toFixed(2)}</span>
                                         <span class="font-bold">R$ ${s.promoPrice.toFixed(2)}</span>` 
                                        : 
                                        `<span class="font-bold">R$ ${s.price.toFixed(2)}</span>`
                                    }
                                    ${s.unit ? `<span class="text-[10px] opacity-70 font-sans font-normal uppercase tracking-wide">${s.unit}</span>` : ''}
                                </div>
                            </td>

                            <td class="p-3 text-center">
                                ${s.isPromotion ? 
                                    `<span class="text-[10px] bg-white border ${theme.border} ${theme.text} px-2 py-1 rounded-lg font-bold shadow-sm">SIM</span>` : 
                                    '<span class="text-gray-300">-</span>'
                                }
                            </td>

                            <td class="p-3 text-center">
                                <span class="inline-flex items-center gap-1.5 text-xs font-bold px-3 py-1 rounded-full bg-white/50 border ${theme.border} ${theme.text}">
                                    <span class="w-1.5 h-1.5 rounded-full ${s.active ? 'bg-green-500' : 'bg-gray-400'}"></span>
                                    ${s.active ? 'Ativo' : 'Inativo'}
                                </span>
                            </td>

                            <td class="p-3 text-right">
                                <div class="flex justify-end gap-2 items-center h-full">
                                    <button onclick="window.app.openServiceEditModal('${s.id}')" class="text-blue-600 hover:bg-white p-2 rounded-full transition shadow-sm"><i class="ph-bold ph-pencil-simple"></i></button>
                                    <button onclick="window.app.deleteService('${s.id}')" class="text-red-500 hover:bg-white p-2 rounded-full transition shadow-sm"><i class="ph-bold ph-trash"></i></button>
                                </div>
                            </td>
                        </tr>
                    `}).join('');
                }
                
                // Atualiza Info da Paginação
                document.getElementById('admin-services-info').innerText = `Mostrando ${paged.length} de ${list.length}`;
                
                // Renderiza Botões de Paginação
                let nav = '';
                const pages = Math.ceil(list.length / adminState.itemsPerPage);
                if(pages > 1) {
                     nav += `<button onclick="window.app.changeAdminPage('services', -1)" class="w-8 h-8 rounded border hover:bg-gray-100 flex items-center justify-center" ${adminState.services.page === 1 ? 'disabled opacity-50' : ''}><i class="ph-bold ph-caret-left"></i></button>`;
                     nav += `<span class="text-xs font-bold px-2 self-center">Pág ${adminState.services.page} / ${pages}</span>`;
                     nav += `<button onclick="window.app.changeAdminPage('services', 1)" class="w-8 h-8 rounded border hover:bg-gray-100 flex items-center justify-center" ${adminState.services.page === pages ? 'disabled opacity-50' : ''}><i class="ph-bold ph-caret-right"></i></button>`;
                }
                document.getElementById('admin-services-pagination').innerHTML = nav;
            }
        }

        function initHome() {
            const container = document.getElementById('home-highlights');
            const heroSection = document.querySelector('section.flex.flex-col-reverse'); 
            const quoteSection = document.querySelector('section.bg-primary.rounded-\\[3rem\\]'); 
            
            if(!container) return;

            // --- HELPER DE TEMAS VISUAIS ---
            const getThemeClasses = (theme) => {
                const map = {
                    'default': { card: 'bg-primary', text: 'text-white', iconBg: 'bg-white/10', iconColor: 'text-accent', sub: 'text-slate-400', desc: 'text-slate-300', btn: 'bg-white text-primary hover:bg-accent hover:text-white' },
                    'orange':  { card: 'bg-gradient-to-br from-orange-500 to-amber-600', text: 'text-white', iconBg: 'bg-white/20', iconColor: 'text-white', sub: 'text-orange-100', desc: 'text-orange-50', btn: 'bg-white text-orange-600 hover:bg-gray-100' },
                    'blue':    { card: 'bg-gradient-to-br from-blue-600 to-indigo-700', text: 'text-white', iconBg: 'bg-white/20', iconColor: 'text-blue-200', sub: 'text-blue-200', desc: 'text-blue-100', btn: 'bg-white text-blue-700 hover:bg-blue-50' },
                    'purple':  { card: 'bg-gradient-to-br from-purple-700 to-fuchsia-800', text: 'text-white', iconBg: 'bg-white/20', iconColor: 'text-fuchsia-200', sub: 'text-purple-200', desc: 'text-purple-100', btn: 'bg-white text-purple-800 hover:bg-purple-50' },
                    'green':   { card: 'bg-gradient-to-br from-emerald-600 to-teal-700', text: 'text-white', iconBg: 'bg-white/20', iconColor: 'text-emerald-100', sub: 'text-emerald-100', desc: 'text-emerald-50', btn: 'bg-white text-teal-700 hover:bg-teal-50' },
                };
                return map[theme] || map['default'];
            };

            // 1. RENDERIZAR HERO (Mantido igual)
            const heroBook = DB.books.find(b => b.id === DB.homeConfig.heroBookId) || DB.books[0];
            if(heroSection && heroBook) {
                const titleWords = heroBook.title.split(' ');
                let formattedTitle = heroBook.title;
                if (titleWords.length > 1) {
                    const lastWord = titleWords.pop();
                    const firstPart = titleWords.join(' ');
                    formattedTitle = `${firstPart} <br><span class="text-transparent bg-clip-text bg-gradient-to-r from-accent to-orange-400 font-serif italic pr-2">${lastWord}.</span>`;
                }

                const badgeContainer = heroSection.querySelector('.inline-flex');
                if(DB.homeConfig.showLaunchBadge) {
                    badgeContainer.classList.remove('hidden'); badgeContainer.classList.add('inline-flex');
                } else {
                    badgeContainer.classList.remove('inline-flex'); badgeContainer.classList.add('hidden');
                }

                heroSection.querySelector('h1').innerHTML = formattedTitle;
                const shortDesc = heroBook.coverSynopsis || (heroBook.synopsis.substring(0, 80) + "...");
                heroSection.querySelector('p').innerText = shortDesc;
                heroSection.querySelector('img').src = heroBook.cover;
                heroSection.querySelector('a').innerText = `Ler Agora`;
                heroSection.querySelector('a').href = `#/livro/${heroBook.id}`;
            }

            // 2. RENDERIZAR DESTAQUES (ATUALIZADO COM TEMAS)
            container.innerHTML = DB.homeConfig.highlights.map(id => {
                const book = DB.books.find(b => b.id === id);
                const service = DB.services.find(s => s.id === id);

                if (book) {
                    return `
                    <div class="card-interaction bg-white p-8 rounded-3xl shadow-lg border border-gray-100 flex flex-col md:flex-row gap-8 items-center relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-40 h-40 bg-accent/5 rounded-full blur-3xl -mr-10 -mt-10"></div>
                        <div class="relative flex-shrink-0 animate-float">
                            <img src="${book.cover}" class="w-32 md:w-36 rounded shadow-xl rotate-3 border-4 border-white group-hover:rotate-0 transition duration-500 cursor-pointer" onclick="window.location.hash='#/livro/${book.id}'">
                        </div>
                        <div class="text-center md:text-left z-10 flex-1">
                            <div class="text-xs font-bold text-accent uppercase tracking-widest mb-2">${book.genre}</div>
                            <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-2 font-serif leading-tight">${book.title}</h3>
                            <p class="text-sm text-gray-500 mb-5 max-w-xs mx-auto md:mx-0 line-clamp-2">${book.synopsis}</p>
                            <button onclick="window.location.hash='#/livro/${book.id}'" class="bg-primary hover:bg-slate-700 text-white py-2 px-6 rounded-full font-bold text-xs md:text-sm transition shadow-lg w-full md:w-auto">
                                Comprar - R$ ${book.price.toFixed(2)}
                            </button>
                        </div>
                    </div>`;
                } else if (service) {
                    // LÓGICA DE TEMA APLICADA AQUI
                    const style = getThemeClasses(service.theme || 'default');
                    const iconClass = service.icon || 'ph-star-four';

                    return `
                    <div class="card-interaction ${style.card} p-8 rounded-3xl shadow-xl flex flex-col justify-center relative overflow-hidden group min-h-[300px]">
                        <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-20"></div>
                        <div class="relative z-10">
                            <div class="flex items-center gap-4 mb-4">
                                <div class="${style.iconBg} p-3 rounded-2xl backdrop-blur-md shadow-sm">
                                    <i class="ph-fill ${iconClass} text-2xl ${style.iconColor}"></i>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold leading-none ${style.text}">${service.name}</h3>
                                    <p class="text-[10px] ${style.sub} uppercase tracking-wide mt-1">Serviço Exclusivo</p>
                                </div>
                            </div>
                            <p class="${style.desc} text-sm mb-6 leading-relaxed line-clamp-3">${service.description}</p>
                            <button onclick="window.app.openServiceModal('${service.id}')" class="w-full py-3 px-8 rounded-full font-bold text-sm transition shadow-md ${style.btn}">
                                Solicitar Orçamento
                            </button>
                        </div>
                    </div>`;
                }
                return '';
            }).join('');

            // 3. RENDERIZAR FRASE
            if(quoteSection) {
                quoteSection.querySelector('h3').innerText = `"${DB.homeConfig.quote.text}"`;
                quoteSection.querySelector('p').innerText = `— ${DB.homeConfig.quote.author}`;
            }
        }

        function initCommunity() {
            const feed = document.getElementById('public-blog-feed');
            const sidebarComments = document.getElementById('sidebar-comments');
            if(!feed) return;

            const publishedPosts = DB.posts.filter(p => p.status === 'published');
            
            feed.innerHTML = publishedPosts.map(post => {
                const userLiked = user && post.likedBy.includes(user.name);
                const isTextBlack = post.coverTextColor === 'black';
                const titleColor = isTextBlack ? 'text-gray-900' : 'text-white drop-shadow-[0_2px_4px_rgba(0,0,0,1)]';
                const metaColor = isTextBlack ? 'text-gray-700' : 'text-white';
                const gradientClass = isTextBlack ? 'from-white via-white/50 to-transparent' : 'from-black via-black/50 to-transparent';
                const likeBtnBorder = isTextBlack ? 'border-gray-300 bg-white/50 hover:bg-white' : 'border-white/20 bg-white/10 hover:bg-white/20';
                const likeIconColor = userLiked ? 'text-red-500' : (isTextBlack ? 'text-gray-900' : 'text-white');
                const linkHTML = post.link ? `<a href="${post.link}" target="_blank" class="text-xs font-bold text-accent hover:underline mt-2 inline-flex items-center gap-1"><i class="ph-bold ph-link"></i> Acessar Link</a>` : '';

                // --- LÓGICA DE EXIBIÇÃO DE COMENTÁRIOS PÚBLICOS ---
                const limit = publicState.expandedComments[post.id] || 3; // Padrão: 3
                const visibleComments = post.comments.slice(0, limit);
                const hasMore = post.comments.length > limit;
                const remaining = post.comments.length - limit;
                // ----------------------------------------------------

                return `
                <div class="group bg-white rounded-3xl overflow-hidden shadow-lg border border-gray-100 relative mb-10">
                    <div class="relative h-[350px] overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-t ${gradientClass} z-10 opacity-90"></div>
                        <img src="${post.image}" class="w-full h-full object-cover group-hover:scale-105 transition duration-700">
                        <div class="absolute bottom-0 left-0 w-full p-8 z-20">
                            <div class="flex justify-between items-end">
                                <div>
                                    <span class="bg-accent text-white px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mb-3 inline-block shadow-lg shadow-black/20">${post.category}</span>
                                    <h3 class="text-3xl font-serif font-bold ${titleColor} mb-2 leading-tight animate-pulse-slow">${post.title}</h3>
                                    <div class="flex items-center gap-4 ${metaColor} text-sm font-medium drop-shadow-md">
                                        <span><i class="ph-fill ph-calendar"></i> ${post.date}</span>
                                    </div>
                                </div>
                                ${post.allowLikes ? `
                                <button onclick="${user ? `window.app.togglePublicPostLike(${post.id})` : 'window.app.connectGoogle()'}" class="w-12 h-12 rounded-full flex items-center justify-center border ${likeBtnBorder} backdrop-blur-md transition transform hover:scale-110 shadow-lg">
                                    <i class="ph-fill ph-heart text-2xl ${likeIconColor} drop-shadow-md"></i>
                                </button>` : ''}
                            </div>
                        </div>
                    </div>

                    <div class="p-8 pt-6">
                        <p class="text-gray-600 leading-relaxed text-lg mb-4">${post.content}</p>
                        ${linkHTML}
                        <div class="border-t border-gray-100 mt-6 pt-6">
                            <div class="flex items-center gap-6 text-sm text-gray-400 mb-6">
                                <span class="flex items-center gap-2 ${userLiked ? 'text-red-500 font-bold' : ''}"><i class="ph-fill ph-heart"></i> ${post.likes} curtidas</span>
                                <span class="flex items-center gap-2"><i class="ph-fill ph-chat-circle"></i> ${post.comments.length} comentários</span>
                            </div>
                            
                            <div class="space-y-4 mb-4">
                                ${visibleComments.map(c => {
                                    const cLiked = user && c.likedBy && c.likedBy.includes(user.name);
                                    return `
                                    <div class="flex gap-3 animate-fade-in">
                                        <img src="${c.avatar}" class="w-8 h-8 rounded-full">
                                        <div class="flex-1">
                                            <div class="bg-gray-50 p-3 rounded-2xl rounded-tl-none relative">
                                                ${c.authorLike ? '<i class="ph-fill ph-star absolute -top-1 -right-1 text-accent bg-white rounded-full p-1 shadow-sm text-xs"></i>' : ''}
                                                <div class="flex justify-between items-baseline"><span class="font-bold text-xs text-gray-900">${c.user}</span><span class="text-[10px] text-gray-400">${c.date}</span></div>
                                                <p class="text-sm text-gray-600">${c.text}</p>
                                            </div>
                                            <div class="flex gap-3 mt-1 ml-2">
                                                <button onclick="${user ? `window.app.togglePublicCommentLike(${post.id}, ${c.id})` : 'window.app.connectGoogle()'}" class="text-[10px] font-bold text-gray-400 hover:text-red-500 flex items-center gap-1"><i class="ph-bold ph-heart"></i> ${c.likes || 0}</button>
                                            </div>
                                        </div>
                                    </div>`;
                                }).join('')}
                            </div>
                            
                            ${hasMore ? `
                                <div class="text-center mb-6">
                                    <button onclick="window.app.loadMoreComments(${post.id})" class="text-xs font-bold text-accent hover:underline py-2">
                                        Ver mais ${remaining > 5 ? 5 : remaining} comentários...
                                    </button>
                                </div>
                            ` : ''}

                            ${post.allowComments ? (user ? `<div class="flex gap-3 items-start"><img src="${user.avatar}" class="w-8 h-8 rounded-full"><div class="flex-1 relative"><textarea id="comment-input-${post.id}" rows="1" placeholder="Comente..." class="w-full bg-gray-50 border-0 rounded-xl p-3 pr-12 text-sm focus:ring-2 focus:ring-accent resize-none"></textarea><button onclick="window.app.publicPostComment(${post.id})" class="absolute right-2 top-2 text-primary hover:text-accent p-1"><i class="ph-bold ph-paper-plane-right text-xl"></i></button></div></div>` : `<button onclick="window.app.connectGoogle()" class="w-full py-3 border border-gray-200 border-dashed rounded-xl text-xs font-bold text-gray-400 hover:bg-gray-50 flex items-center justify-center gap-2"><i class="ph-bold ph-sign-in"></i> Faça login</button>`) : '<p class="text-center text-xs text-gray-400 italic">Comentários desativados.</p>'}
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
            const allComments = [];
            DB.posts.forEach(p => p.comments.forEach(c => allComments.push({...c, postTitle: p.title})));
            sidebarComments.innerHTML = allComments.slice(0, 5).map(c => `<div class="flex gap-3 pb-4 border-b border-gray-50 last:border-0"><img src="${c.avatar}" class="w-8 h-8 rounded-full"><div><p class="text-xs text-gray-600"><span class="font-bold text-primary">${c.user}</span> comentou:</p><p class="text-xs italic text-gray-500 my-1 line-clamp-2">"${c.text}"</p><p class="text-[10px] text-accent font-bold truncate max-w-[200px]">${c.postTitle}</p></div></div>`).join('');
        }

        function initLivros() {
                    const grid = document.getElementById('books-grid');
                    const controls = document.getElementById('pagination-controls');
                    if(!grid) return;

                    // FILTRO: Mostrar apenas livros ATIVOS
                    const activeBooks = DB.books.filter(b => b.active === true);

                    // Paginação (Agora baseada nos livros ativos)
                    const start = (currentPage - 1) * itemsPerPage;
                    const booksToShow = activeBooks.slice(start, start + itemsPerPage);
                    const totalPages = Math.ceil(activeBooks.length / itemsPerPage);

                    grid.innerHTML = booksToShow.map(b => {
                        const isFav = favorites.includes(b.id);
                        const heartClass = isFav ? 'ph-fill text-red-500' : 'ph-bold text-gray-400';
                        
                        return `
                        <div class="bg-white p-5 rounded-3xl shadow-lg border border-gray-50 flex flex-col h-full group hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2">
                            <div class="relative mb-5 overflow-hidden rounded-2xl bg-gray-100 aspect-[2/3] shadow-inner">
                                <img src="${b.cover}" class="w-full h-full object-cover transition duration-700 group-hover:scale-110 cursor-pointer" onclick="window.location.hash='#/livro/${b.id}'">
                                <button onclick="window.app.toggleFavorite('${b.id}')" class="absolute top-3 right-3 w-10 h-10 bg-white/90 backdrop-blur rounded-full flex items-center justify-center shadow-md hover:scale-110 transition z-20">
                                    <i class="${heartClass} ph-heart text-xl transition-colors"></i>
                                </button>
                            </div>
                            <div class="text-center">
                                <p class="text-[10px] font-bold text-accent uppercase tracking-wider mb-2">${b.genre}</p>
                                <h3 class="text-xl font-bold text-gray-900 leading-tight font-serif cursor-pointer hover:text-accent transition mb-4" onclick="window.location.hash='#/livro/${b.id}'">${b.title}</h3>
                                <button onclick="window.location.hash='#/livro/${b.id}'" class="w-full bg-gray-50 hover:bg-primary hover:text-white text-primary font-bold text-sm py-3 rounded-xl transition border border-gray-200 hover:border-primary">
                                    Comprar - R$ ${b.isPromotion && b.promoPrice ? b.promoPrice.toFixed(2) : b.price.toFixed(2)}
                                </button>
                            </div>
                        </div>`;
                    }).join('');

                    let paginationHTML = ``;
                    if(totalPages > 1) {
                        paginationHTML += `<button onclick="window.app.changePage(${currentPage - 1})" class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''}><i class="ph ph-caret-left"></i></button>`;
                        for(let i = 1; i <= totalPages; i++) { paginationHTML += `<button onclick="window.app.changePage(${i})" class="pagination-btn ${i === currentPage ? 'active' : ''}">${i}</button>`; }
                        paginationHTML += `<button onclick="window.app.changePage(${currentPage + 1})" class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''}><i class="ph ph-caret-right"></i></button>`;
                    }
                    controls.innerHTML = paginationHTML;
                }

        function initServicos() { 
                    const grid = document.getElementById('services-grid'); 
                    if(!grid) return; 
                    
                    // Mapa de cores para textos/bordas (versão light para fundo branco)
                    const colorMap = {
                        'default': 'text-primary border-primary',
                        'orange': 'text-orange-500 border-orange-500',
                        'blue': 'text-blue-600 border-blue-600',
                        'purple': 'text-purple-600 border-purple-600',
                        'green': 'text-emerald-600 border-emerald-600'
                    };

                    grid.innerHTML = DB.services.map((s, index) => {
                        const themeClass = colorMap[s.theme || 'default'];
                        const iconClass = s.icon || 'ph-star-four';

                        return `
                        <div class="card-interaction bg-white p-10 rounded-[2rem] shadow-xl border border-gray-100 flex flex-col h-full relative overflow-hidden group">
                            <div class="absolute top-0 left-0 w-full h-2 bg-current ${themeClass.split(' ')[0]} opacity-80"></div>
                            
                            <div class="flex justify-between items-start mb-6">
                                <div class="p-3 bg-gray-50 rounded-2xl text-3xl ${themeClass.split(' ')[0]}">
                                    <i class="ph-fill ${iconClass}"></i>
                                </div>
                                <div class="text-6xl text-gray-100 font-black z-0 group-hover:text-gray-200 transition">0${index+1}</div>
                            </div>

                            <div class="relative z-10 flex-1">
                                <h3 class="text-2xl font-bold text-gray-900 mb-3 font-serif">${s.name}</h3>
                                <div class="text-4xl font-black text-slate-800 mb-6 flex items-baseline gap-2">
                                    R$ ${s.price} <span class="text-xs font-bold text-gray-400 uppercase tracking-wide">${s.unit || ''}</span>
                                </div>
                                <p class="text-gray-600 mb-10 text-base leading-relaxed">${s.description}</p>
                            </div>
                            <button onclick="window.app.openServiceModal('${s.id}')" class="w-full bg-primary text-white py-4 rounded-xl font-bold text-sm transition hover:bg-accent hover:shadow-xl hover:-translate-y-1">
                                Solicitar Orçamento
                            </button>
                        </div>`;
                    }).join(''); 
                }

        function initAbout() {
            // Dados básicos e imagens
            const els = {
                name: document.getElementById('about-name-display'),
                role: document.getElementById('author-role-display'),
                bio: document.getElementById('about-bio-display'),
                imgMain: document.getElementById('about-main-img'),
                imgSec: document.getElementById('about-sec-img'),
                caption: document.getElementById('about-sec-caption')
            };

            if(els.name) els.name.innerHTML = `Olá! Sou o <strong class="text-primary">${DB.author.name}</strong>.`;
            if(els.role) els.role.innerText = DB.author.role;
            if(els.bio) els.bio.innerText = DB.author.bio;
            if(els.imgMain) els.imgMain.src = DB.author.avatar;
            if(els.imgSec) els.imgSec.src = DB.author.secondaryImage;
            if(els.caption) els.caption.innerText = DB.author.secondaryCaption;

            // Renderizar Timeline
            const timelineContainer = document.getElementById('about-timeline-list');
            if(timelineContainer && DB.author.timeline) {
                timelineContainer.innerHTML = DB.author.timeline.map((item, index) => `
                    <div class="relative group">
                        <div class="absolute -left-[41px] top-1 w-5 h-5 bg-gray-300 rounded-full border-4 border-white transition group-hover:bg-accent group-hover:scale-125 shadow-sm"></div>
                        <h4 class="font-bold text-primary text-xl">${item.year}</h4>
                        <p class="font-bold text-gray-700 text-sm mb-1">${item.title}</p>
                        <p class="text-sm text-gray-500 leading-relaxed">${item.desc}</p>
                    </div>
                `).join('');
            }
        }
  
        function getBooksTableHTML() {
            return `
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div><h3 class="font-bold text-lg text-primary flex items-center gap-2"><i class="ph-fill ph-book text-accent"></i> Catálogo de Livros</h3></div>
                    <div class="flex gap-2 flex-1 justify-end w-full md:w-auto">
                        <input type="text" placeholder="Buscar livro..." oninput="window.app.setAdminFilter('books', 'filter', this.value)" class="bg-gray-50 border border-gray-200 rounded-lg text-xs p-2 w-full md:w-64 focus:outline-none focus:border-accent">
                        <button onclick="window.app.openBookModal()" class="text-white bg-primary px-4 py-2 rounded-lg text-xs font-bold uppercase hover:bg-accent transition shadow-lg flex items-center gap-2 whitespace-nowrap"><i class="ph-bold ph-plus"></i> Novo</button>
                    </div>
                </div>
                <div class="overflow-x-auto min-h-[300px]">
                    <table class="w-full text-left text-sm text-gray-600">
                        <thead class="bg-gray-50 text-gray-400 uppercase text-xs border-b border-gray-200">
                            <tr>
                                <th class="p-3">Capa</th>
                                <th class="p-3 cursor-pointer hover:text-primary transition select-none group" onclick="window.app.sortData('books', 'title')">
                                    Título <i id="sort-books-title" class="ph-bold ph-arrows-down-up text-gray-300 group-hover:text-primary ml-1 align-middle"></i>
                                </th>
                                <th class="p-3 cursor-pointer hover:text-primary transition select-none group" onclick="window.app.sortData('books', 'price')">
                                    Preço <i id="sort-books-price" class="ph-bold ph-arrows-down-up text-gray-300 group-hover:text-primary ml-1 align-middle"></i>
                                </th>
                                <th class="p-3 text-center cursor-pointer hover:text-primary transition select-none group" onclick="window.app.sortData('books', 'isPromotion')">
                                    Promoção <i id="sort-books-isPromotion" class="ph-bold ph-arrows-down-up text-gray-300 group-hover:text-primary ml-1 align-middle"></i>
                                </th>
                                <th class="p-3 text-center cursor-pointer hover:text-primary transition select-none group" onclick="window.app.sortData('books', 'active')">
                                    Status <i id="sort-books-active" class="ph-bold ph-arrows-down-up text-gray-300 group-hover:text-primary ml-1 align-middle"></i>
                                </th>
                                <th class="p-3 text-right">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="admin-books-table"></tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center border-t border-gray-100 pt-4 mt-4"><span class="text-xs text-gray-400" id="admin-books-info">Mostrando 0 de 0</span><div class="flex gap-2" id="admin-books-pagination"></div></div>
            `;
        }

        function getServicesTableHTML() {
            return `
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div><h3 class="font-bold text-lg text-primary flex items-center gap-2"><i class="ph-fill ph-briefcase text-blue-500"></i> Meus Serviços</h3></div>
                    <div class="flex gap-2 flex-1 justify-end w-full md:w-auto">
                        <input type="text" placeholder="Buscar serviço..." oninput="window.app.setAdminFilter('services', 'filter', this.value)" class="bg-gray-50 border border-gray-200 rounded-lg text-xs p-2 w-full md:w-64 focus:outline-none focus:border-blue-500">
                        <button onclick="window.app.openServiceEditModal()" class="text-white bg-blue-600 px-4 py-2 rounded-lg text-xs font-bold uppercase hover:bg-blue-700 transition shadow-lg flex items-center gap-2 whitespace-nowrap"><i class="ph-bold ph-plus"></i> Novo</button>
                    </div>
                </div>
                <div class="overflow-x-auto min-h-[200px]">
                    <table class="w-full text-left text-sm text-gray-600">
                        <thead class="bg-blue-50 text-blue-400 uppercase text-xs border-b border-blue-100">
                            <tr>
                                <th class="p-3 cursor-pointer hover:text-blue-700 transition select-none group" onclick="window.app.sortData('services', 'name')">
                                    Serviço <i id="sort-services-name" class="ph-bold ph-arrows-down-up text-blue-300 group-hover:text-blue-700 ml-1 align-middle"></i>
                                </th>
                                <th class="p-3 cursor-pointer hover:text-blue-700 transition select-none group" onclick="window.app.sortData('services', 'price')">
                                    Preço Base <i id="sort-services-price" class="ph-bold ph-arrows-down-up text-blue-300 group-hover:text-blue-700 ml-1 align-middle"></i>
                                </th>
                                <th class="p-3 text-center cursor-pointer hover:text-blue-700 transition select-none group" onclick="window.app.sortData('services', 'isPromotion')">
                                    Promoção <i id="sort-services-isPromotion" class="ph-bold ph-arrows-down-up text-blue-300 group-hover:text-blue-700 ml-1 align-middle"></i>
                                </th>
                                <th class="p-3 text-center cursor-pointer hover:text-blue-700 transition select-none group" onclick="window.app.sortData('services', 'active')">
                                    Status <i id="sort-services-active" class="ph-bold ph-arrows-down-up text-blue-300 group-hover:text-blue-700 ml-1 align-middle"></i>
                                </th>
                                <th class="p-3 text-right">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="admin-services-table"></tbody>
                    </table>
                </div>
                <div class="flex justify-between items-center border-t border-gray-100 pt-4 mt-4"><span class="text-xs text-gray-400" id="admin-services-info">Mostrando 0 de 0</span><div class="flex gap-2" id="admin-services-pagination"></div></div>
            `;
        }

        function renderBooksTableRows() {renderBooksTable(); } 
        function renderServicesTableRows() {renderServicesTable(); }        

        function renderBooksTable() {
            // 1. Filtra e Ordena
            let list = DB.books.filter(b => b.title.toLowerCase().includes(adminState.books.filter.toLowerCase()));
            list.sort((a, b) => {
                let vA = a[adminState.books.sortKey], vB = b[adminState.books.sortKey];
                if (typeof vA === 'string') vA = vA.toLowerCase(); if (typeof vB === 'string') vB = vB.toLowerCase();
                if (vA < vB) return adminState.books.sortOrder === 'asc' ? -1 : 1; if (vA > vB) return adminState.books.sortOrder === 'asc' ? 1 : -1; return 0;
            });

            // 2. Pagina
            const start = (adminState.books.page - 1) * adminState.itemsPerPage;
            const paged = list.slice(start, start + adminState.itemsPerPage);

            // 3. Injeta no HTML (COM O DESIGN RICO RECUPERADO)
            const tbody = document.getElementById('admin-books-table');
            if (tbody) {
                if(paged.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-gray-400">Nenhum livro encontrado.</td></tr>`;
                } else {
                    tbody.innerHTML = paged.map(b => `
                        <tr class="border-b border-gray-100 hover:bg-gray-50 transition group ${b.active ? '' : 'opacity-60 bg-gray-50'}">
                            <td class="p-3"><img src="${b.cover}" class="w-10 h-14 object-cover rounded shadow-sm"></td>
                            <td class="p-3 font-bold text-primary">${b.title}</td>
                            <td class="p-3 text-gray-500">
                                ${b.isPromotion && b.promoPrice ? 
                                    `<div class="flex flex-col"><span class="line-through text-xs text-gray-400">R$ ${b.price.toFixed(2)}</span><span class="text-green-600 font-bold">R$ ${b.promoPrice.toFixed(2)}</span></div>` : 
                                    `R$ ${b.price.toFixed(2)}`
                                }
                            </td>
                            <td class="p-3 text-center">
                                ${b.isPromotion ? 
                                    '<span class="text-[10px] bg-orange-50 text-orange-700 border border-orange-200 px-2 py-0.5 rounded font-bold">SIM</span>' : 
                                    '<span class="text-[10px] text-gray-300">-</span>'
                                }
                            </td>
                            <td class="p-3 text-center">
                                <span class="inline-flex items-center gap-1.5 text-xs font-bold px-2 py-1 rounded-full ${b.active ? 'bg-green-100 text-green-700 border border-green-200' : 'bg-gray-100 text-gray-500 border border-gray-200'}">
                                    <span class="w-1.5 h-1.5 rounded-full ${b.active ? 'bg-green-500' : 'bg-gray-400'}"></span>
                                    ${b.active ? 'Ativo' : 'Inativo'}
                                </span>
                            </td>
                            <td class="p-3 text-right">
                                <button onclick="window.app.openBookModal('${b.id}')" class="text-blue-500 hover:bg-blue-50 p-2 rounded-full transition"><i class="ph-bold ph-pencil-simple"></i></button>
                                <button onclick="window.app.deleteBook('${b.id}')" class="text-red-400 hover:bg-red-50 p-2 rounded-full transition"><i class="ph-bold ph-trash"></i></button>
                            </td>
                        </tr>`).join('');
                }
                document.getElementById('admin-books-info').innerText = `Mostrando ${paged.length} de ${list.length}`;
            }
        }
        
        function initHeaderLogic() { const btn = document.getElementById('menu-button'); const menu = document.getElementById('mobile-menu'); if(btn && menu) { btn.onclick = (e) => { e.stopPropagation(); menu.classList.toggle('hidden'); }; document.addEventListener('click', (e) => { if (!menu.contains(e.target) && !btn.contains(e.target)) menu.classList.add('hidden'); }); } const header = document.getElementById('header-container'); window.addEventListener('scroll', () => { if(window.scrollY > 10) { header.classList.add('glass-header'); header.classList.remove('py-4'); header.classList.add('py-2'); } else { header.classList.remove('glass-header'); header.classList.remove('py-2'); header.classList.add('py-4'); } }); }

        window.app = {
            toast: (msg, type) => showToast(msg, type),
            _pendingConfirmAction: null,

            cropper: null,
                currentCropCallback: null,

            handleImageUpload: (input, targetImgId, targetInputId, aspectRatio = 1) => {
                    const file = input.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const modal = document.getElementById('cropper-modal');
                        const image = document.getElementById('cropper-image');
                        
                        image.src = e.target.result;
                        modal.classList.remove('hidden');

                        if (window.app.cropper) { window.app.cropper.destroy(); }

                        window.app.cropper = new Cropper(image, {
                            aspectRatio: aspectRatio,
                            viewMode: 1,
                            dragMode: 'move',
                            autoCropArea: 1,
                        });

                        // Define o que acontece ao confirmar
                        window.app.currentCropCallback = (base64) => {
                            // Atualiza o preview visual
                            const imgPreview = document.getElementById(targetImgId);
                            if(imgPreview) imgPreview.src = base64;
                            
                            // Atualiza o input hidden que será salvo
                            const inputHidden = document.getElementById(targetInputId);
                            if(inputHidden) inputHidden.value = base64;
                            
                            // Reseta o input file para permitir selecionar a mesma foto se quiser
                            input.value = '';
                        };
                    };
                    reader.readAsDataURL(file);
            },

            confirmCrop: () => {
                    if (!window.app.cropper) return;
                    // Gera o Base64 (qualidade 0.8 para não pesar tanto o LocalStorage)
                    const canvas = window.app.cropper.getCroppedCanvas({ maxWidth: 800, maxHeight: 800 });
                    const base64 = canvas.toDataURL('image/jpeg', 0.8);
                    
                    if (window.app.currentCropCallback) window.app.currentCropCallback(base64);
                    window.app.cancelCrop();
            },

            cancelCrop: () => {
                    document.getElementById('cropper-modal').classList.add('hidden');
                    if (window.app.cropper) {
                        window.app.cropper.destroy();
                        window.app.cropper = null;
                    }
                    window.app.currentCropCallback = null;
            },

            setAdminTab: (tab) => {
                adminState.currentTab = tab;
                initDashboard(); // Re-renderiza o painel
            },

            filterLeads: (days) => {
                adminState.leads.filterDays = days === 'all' ? 'all' : parseInt(days);
                adminState.leads.page = 1; // Reseta para pág 1 ao filtrar
                initDashboard();
            },
            
            changeLeadsPage: (dir) => {
                adminState.leads.page += dir;
                initDashboard();
                document.getElementById('dashboard-content').scrollIntoView({ behavior: 'smooth' });
            },
            
            exportLeads: () => {
                // Lógica simples de exportação CSV
                let csv = "ID,Nome,Email,Serviço,Data,Status,Descrição\n";
                DB.leads.forEach(l => {
                    csv += `${l.id},"${l.name}","${l.email}","${l.service}","${l.date}",${l.status},"${l.desc.replace(/"/g, '""')}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `leads_export_${new Date().toISOString().slice(0,10)}.csv`;
                a.click();
                window.app.toast('Download do CSV iniciado!', 'success');
            },          

            setLeadSubTab: (tab) => {
                adminState.leads.subTab = tab;
                adminState.leads.page = 1;
                initDashboard();
            },
            
            setLeadStatusFilter: (status) => {
                adminState.leads.statusFilter = status;
                adminState.leads.page = 1;
                initDashboard();
            },
            
            exportMetricsCsv: () => {
                const totalClicks = DB.stats.clicksAmazon + DB.stats.clicksML + DB.stats.clicksShopee;
                const serviceCounts = {};
                DB.leads.forEach(l => { serviceCounts[l.service] = (serviceCounts[l.service] || 0) + 1; });
                const statusCounts = { pending: 0, working: 0, finished: 0, cancelled: 0 };
                DB.leads.forEach(l => { if(statusCounts[l.status] !== undefined) statusCounts[l.status]++; });

                let csv = "METRICA,VALOR\n";
                csv += `Total Cliques Amazon,${DB.stats.clicksAmazon}\n`;
                csv += `Total Cliques ML,${DB.stats.clicksML}\n`;
                csv += `Total Cliques Shopee,${DB.stats.clicksShopee}\n`;
                csv += `TOTAL GERAL CLIQUES,${totalClicks}\n\n`;
                
                csv += "SERVICO,QUANTIDADE\n";
                Object.entries(serviceCounts).forEach(([k,v]) => csv += `"${k}",${v}\n`);
                csv += "\n";
                
                csv += "STATUS,QUANTIDADE\n";
                Object.entries(statusCounts).forEach(([k,v]) => csv += `"${k}",${v}\n`);

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `relatorio_analytics_${new Date().toISOString().slice(0,10)}.csv`;
                a.click();
                window.app.toast('Download do Relatório iniciado!', 'success');
            },

            setLeadSearch: (term) => { adminState.leads.searchTerm = term; adminState.leads.page = 1; initDashboard(); },
            setLeadSort: (order) => { adminState.leads.sortOrder = order; initDashboard(); },
            modalFilter: (status, email) => { adminState.leadModal.filterStatus = status; adminState.leadModal.page = 1; window.app.openLeadModal(email); },
            modalPage: (dir, email) => { adminState.leadModal.page += dir; window.app.openLeadModal(email); },
            
            openLeadModal: (email) => {
                const leads = DB.leads.filter(l => l.email === email);
                if(leads.length === 0) return;
                
                leads.sort((a, b) => {
                    const priority = { 'working': 0, 'analyzing': 1, 'pending': 2, 'finished': 3, 'cancelled': 4 };
                    return priority[a.status] - priority[b.status];
                });

                const mainLead = leads[0]; 

                const getStatusColor = (s) => {
                    if(s === 'pending') return 'bg-yellow-50 text-yellow-700 border-yellow-200';
                    if(s === 'analyzing') return 'bg-orange-50 text-orange-700 border-orange-200';
                    if(s === 'working') return 'bg-blue-50 text-blue-700 border-blue-200';
                    if(s === 'finished') return 'bg-green-50 text-green-700 border-green-200';
                    return 'bg-gray-50 text-gray-500 border-gray-200';
                };
                
                const getCardBg = (s) => {
                    if(s === 'working') return 'bg-blue-50/50 border-blue-200';
                    if(s === 'finished') return 'bg-green-50/50 border-green-200';
                    if(s === 'cancelled') return 'bg-gray-50/50 border-gray-200 opacity-75';
                    return 'bg-white border-gray-200';
                };

                const body = `
                    <div class="h-[75vh] flex flex-col bg-gray-50 -m-8">
                        <div class="bg-white p-8 border-b border-gray-200 flex flex-col md:flex-row justify-between items-start gap-4">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-primary to-slate-800 flex items-center justify-center text-white text-3xl font-serif">
                                    ${mainLead.name.charAt(0)}
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-gray-800">${mainLead.name}</h3>
                                    <div class="flex flex-col gap-1 mt-1">
                                        <p class="text-gray-500 text-sm flex items-center gap-2"><i class="ph-bold ph-envelope"></i> ${mainLead.email}</p>
                                        <p class="text-gray-500 text-sm flex items-center gap-2"><i class="ph-bold ph-whatsapp-logo"></i> ${mainLead.phone || 'Não informado'}</p>
                                    </div>
                                    <div class="flex gap-2 mt-2">
                                        <span class="text-[10px] bg-primary/10 text-primary px-2 py-0.5 rounded font-bold uppercase">${leads.length} Pedidos</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <a href="https://wa.me/55${(mainLead.phone || '').replace(/\D/g,'')}" target="_blank" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition shadow-sm"><i class="ph-bold ph-whatsapp-logo"></i> WhatsApp</a>
                                <a href="mailto:${mainLead.email}" class="bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition shadow-sm"><i class="ph-bold ph-envelope-simple"></i> E-mail</a>
                            </div>
                        </div>

                        <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-4">
                            ${leads.map(lead => `
                                <div id="card-lead-${lead.id}" class="border rounded-xl p-5 shadow-sm transition duration-300 relative overflow-hidden ${getCardBg(lead.status)}">
                                    <div class="flex flex-col md:flex-row justify-between items-start gap-4">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-2">
                                                <span class="bg-primary/10 text-primary text-xs font-mono px-2 py-0.5 rounded font-bold">#${lead.id}</span>
                                                <h4 class="font-bold text-gray-800 text-sm uppercase tracking-wide">${lead.service}</h4>
                                                <span class="text-xs text-gray-500 border-l pl-2 border-gray-300">R$ ${lead.value || 'Sob Consulta'}</span>
                                            </div>
                                            <span class="text-xs text-gray-400 flex items-center gap-1 mb-3"><i class="ph-bold ph-calendar"></i> Registrado em: ${lead.date}</span>
                                            <div class="bg-white/60 p-3 rounded-lg border border-gray-200/50 text-sm text-gray-600 italic mb-3">"${lead.desc}"</div>
                                        </div>

                                        <div class="flex flex-col items-end gap-2">
                                            <div id="status-badge-${lead.id}" class="px-3 py-1 rounded-full text-[10px] font-bold uppercase border ${getStatusColor(lead.status)}">
                                                ${lead.status}
                                            </div>
                                            <button onclick="window.app.openAnalysisModal(${lead.id}, '${email}')" class="bg-primary hover:bg-slate-800 text-white px-5 py-2 rounded-lg text-xs font-bold shadow-md transition flex items-center gap-2">
                                                <i class="ph-bold ph-magnifying-glass"></i> Análise
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                window.app.openModalGeneric(" ", body, ""); 
            },

            setLeadSearch: (term) => {
                adminState.leads.searchTerm = term;
                adminState.leads.page = 1;
                initDashboard();
            },            

            updateLeadStatus: (id, newStatus, email) => {
                const lead = DB.leads.find(l => l.id === id);
                if(lead) {
                    lead.status = newStatus;
                    window.app.toast(`Status alterado para: ${newStatus.toUpperCase()}`, 'success');
                    initDashboard(); 
                    window.app.openAnalysisModal(id, email);
                }
            },
            
            saveLeadNote: (id, note) => {
                const lead = DB.leads.find(l => l.id === id);
                if(lead) lead.notes = note;
            },            
            
            openAnalysisModal: (id, email) => {
                const lead = DB.leads.find(l => l.id === id);
                if(!lead) return;

                // Status Labels Traduzidos
                const statusLabels = {
                    'pending': 'Pendente', 'analyzing': 'Em Análise', 'working': 'Atuando',
                    'finished': 'Finalizado', 'cancelled': 'Cancelado'
                };

                const body = `
                    <div class="h-[80vh] flex flex-col bg-gray-50 -m-8">
                        <div class="bg-white p-6 border-b border-gray-200 flex items-center justify-between shadow-sm z-10">
                            <button onclick="window.app.openLeadModal('${email}')" class="text-gray-500 hover:text-primary font-bold text-sm flex items-center gap-2 transition">
                                <i class="ph-bold ph-arrow-left"></i> Voltar para Lista
                            </button>
                            <div class="text-right">
                                <div class="flex items-center justify-end gap-2">
                                    <h3 class="text-lg font-bold text-gray-800">Pedido #${lead.id}</h3>
                                    <span class="text-[10px] bg-gray-100 border border-gray-200 text-gray-500 px-2 py-0.5 rounded uppercase font-bold">${lead.date}</span>
                                </div>
                                <p class="text-sm font-bold text-primary mt-1">${lead.service} <span class="text-gray-300 mx-2">|</span> <span class="text-green-600">R$ ${lead.value ? lead.value.toFixed(2) : 'A Definir'}</span></p>
                            </div>
                        </div>
                        
                        <div class="flex-1 overflow-y-auto custom-scrollbar p-8">
                            <div class="max-w-4xl mx-auto w-full space-y-6">
                                
                                <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4">
                                    <div class="flex items-center gap-4">
                                        <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-slate-500">
                                            <i class="ph-duotone ph-user text-2xl"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-gray-800">${lead.name}</h4>
                                            <p class="text-xs text-gray-400">Entre em contato direto:</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-3">
                                        <a href="https://wa.me/55${(lead.phone || '').replace(/\D/g,'')}" target="_blank" class="flex items-center gap-2 bg-green-50 text-green-600 border border-green-100 px-5 py-2.5 rounded-xl font-bold text-xs hover:bg-green-100 transition">
                                            <i class="ph-bold ph-whatsapp-logo text-lg"></i> WhatsApp
                                        </a>
                                        <a href="mailto:${lead.email}" class="flex items-center gap-2 bg-blue-50 text-blue-600 border border-blue-100 px-5 py-2.5 rounded-xl font-bold text-xs hover:bg-blue-100 transition">
                                            <i class="ph-bold ph-envelope-simple text-lg"></i> E-mail
                                        </a>
                                    </div>
                                </div>

                                <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm">
                                    <label class="text-xs font-bold text-gray-400 uppercase tracking-widest block mb-4 flex items-center gap-2">
                                        <i class="ph-fill ph-faders"></i> Alterar Status do Pedido
                                    </label>
                                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                                        ${['pending', 'analyzing', 'working', 'finished', 'cancelled'].map(s => `
                                            <button onclick="window.app.updateLeadStatus(${lead.id}, '${s}', '${email}')" 
                                                class="flex flex-col items-center justify-center py-4 rounded-xl border-2 transition duration-200 ${lead.status === s ? 'border-primary bg-primary text-white shadow-lg transform scale-105' : 'border-gray-100 bg-gray-50 text-gray-400 hover:border-gray-300 hover:bg-white'}">
                                                <i class="ph-bold ${s === 'finished' ? 'ph-check-circle' : (s === 'cancelled' ? 'ph-x-circle' : 'ph-hourglass')} text-xl mb-1"></i>
                                                <span class="text-[10px] font-bold uppercase">${statusLabels[s]}</span>
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm h-full">
                                        <label class="text-xs font-bold text-gray-400 uppercase tracking-widest block mb-3 flex items-center gap-2">
                                            <i class="ph-fill ph-chat-text"></i> Mensagem do Cliente
                                        </label>
                                        <div class="bg-gray-50 p-5 rounded-xl border border-gray-100 h-[calc(100%-2rem)]">
                                            <p class="text-gray-700 italic leading-relaxed text-sm">"${lead.desc}"</p>
                                        </div>
                                    </div>

                                    <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm h-full">
                                        <label class="text-xs font-bold text-gray-400 uppercase tracking-widest block mb-3 flex items-center gap-2">
                                            <i class="ph-fill ph-notebook"></i> Notas Internas
                                        </label>
                                        <textarea rows="6" placeholder="Escreva observações sobre o andamento..." class="w-full bg-yellow-50/50 border border-yellow-100 rounded-xl p-4 text-sm text-gray-700 focus:outline-none focus:border-accent focus:ring-1 focus:ring-accent resize-none h-[calc(100%-2rem)]" onchange="window.app.saveLeadNote(${lead.id}, this.value)">${lead.notes || ''}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                window.app.openModalGeneric(" ", body, ""); 
            },

            selectedPostId: null,

            selectAdminPost: (id) => {
                window.app.selectedPostId = id;
                initDashboard();
            },

            togglePublicPostLike: (postId) => {
                    const post = DB.posts.find(p => p.id === postId);
                    if(!post) return;
                    
                    const userIndex = post.likedBy.indexOf(user.name);
                    if(userIndex === -1) {
                        post.likedBy.push(user.name);
                        post.likes++;
                    } else {
                        post.likedBy.splice(userIndex, 1);
                        post.likes--;
                    }
                    initCommunity();
                },
                
            togglePublicCommentLike: (postId, commentId) => {
                    const post = DB.posts.find(p => p.id === postId);
                    const comment = post.comments.find(c => c.id === commentId);
                    if(!comment) return;

                    if(!comment.likedBy) comment.likedBy = [];
                    
                    const userIndex = comment.likedBy.indexOf(user.name);
                    if(userIndex === -1) {
                        comment.likedBy.push(user.name);
                        comment.likes = (comment.likes || 0) + 1;
                    } else {
                        comment.likedBy.splice(userIndex, 1);
                        comment.likes--;
                    }
                    initCommunity();
                },

            publicPostComment: (postId) => {
                    const text = document.getElementById(`comment-input-${postId}`).value;
                    if(!text.trim()) return;

                    const post = DB.posts.find(p => p.id === postId);
                    post.comments.push({
                        id: Date.now(),
                        user: user.name,
                        avatar: user.avatar,
                        text: text,
                        date: "Agora mesmo",
                        likes: 0,
                        likedBy: [],
                        authorLike: false
                    });
                    initCommunity();
                },

            adminDeleteComment: (postId, commentId) => {
                    window.app.openConfirmModal('Excluir Comentário?', 'Isso sumirá da página pública.', 'danger', 'Excluir', () => {
                        const post = DB.posts.find(p => p.id === postId);
                        post.comments = post.comments.filter(c => c.id !== commentId);
                        // Atualiza onde estiver (seja na home ou admin)
                        if(document.getElementById('admin-post-detail')) window.app.renderAdminPostDetail(postId);
                        if(document.getElementById('public-blog-feed')) initCommunity();
                        window.app.toast('Comentário removido.', 'success');
                    });
                },
                
            adminReplyComment: (postId) => {
                    // ... lógica similar ao publicPostComment mas forçando user admin ...
                    // Simplificação: o admin usa a interface pública ou cria um campo no detalhe
                },

            renderAdminPostDetail: (id) => {
                const post = DB.posts.find(p => p.id === id);
                const container = document.getElementById('admin-post-detail');
                if(!container || !post) return;

                // --- LÓGICA DE FILTRO E PAGINAÇÃO DE COMENTÁRIOS ---
                let filteredComments = post.comments.filter(c => {
                    const matchesText = c.text.toLowerCase().includes(adminState.postComments.filterText.toLowerCase()) || 
                                      c.user.toLowerCase().includes(adminState.postComments.filterText.toLowerCase());
                    
                    let matchesDate = true;
                    if (adminState.postComments.filterDate !== 'all') {
                        // Converte DD/MM/AAAA para Date
                        const parts = c.date.split('/');
                        const cDate = new Date(parts[2], parts[1]-1, parts[0]);
                        const cutoff = new Date();
                        cutoff.setDate(cutoff.getDate() - parseInt(adminState.postComments.filterDate));
                        matchesDate = cDate >= cutoff;
                    }
                    return matchesText && matchesDate;
                });

                const totalComments = filteredComments.length;
                const totalPages = Math.ceil(totalComments / adminState.postComments.itemsPerPage);
                // Garante que a página atual é válida
                if (adminState.postComments.page > totalPages && totalPages > 0) adminState.postComments.page = totalPages;
                
                const start = (adminState.postComments.page - 1) * adminState.postComments.itemsPerPage;
                const pagedComments = filteredComments.slice(start, start + adminState.postComments.itemsPerPage);
                // ----------------------------------------------------

                // Lógica de Cor do Preview (igual ao anterior)
                const isTextBlack = post.coverTextColor === 'black';
                const titleColor = isTextBlack ? 'text-gray-900' : 'text-white drop-shadow-md';
                const gradientClass = isTextBlack ? 'from-white via-white/50 to-transparent' : 'from-black/90 via-black/40 to-transparent';

                container.className = "lg:col-span-2 bg-white border border-gray-200 rounded-2xl flex flex-col overflow-hidden shadow-sm relative";
                container.innerHTML = `
                    <div class="h-16 border-b border-gray-100 flex items-center justify-between px-6 bg-white shrink-0">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-gray-400 uppercase">Editando:</span>
                            <span class="font-bold text-primary truncate max-w-[200px]">${post.title}</span>
                            ${!post.allowComments ? '<span class="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded ml-2">Coments Off</span>' : ''}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.app.openPostModal(${post.id})" class="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition" title="Editar"><i class="ph-bold ph-pencil-simple text-lg"></i></button>
                            <button onclick="window.app.deletePost(${post.id})" class="p-2 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-lg transition" title="Excluir"><i class="ph-bold ph-trash text-lg"></i></button>
                        </div>
                    </div>

                    <div class="flex-1 overflow-y-auto custom-scrollbar p-8 bg-gray-50/50">
                        <div class="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8">
                            <div class="relative h-40 rounded-lg overflow-hidden mb-4 group">
                                <div class="absolute inset-0 bg-gradient-to-t ${gradientClass} z-10"></div>
                                <img src="${post.image}" class="w-full h-full object-cover">
                                <div class="absolute bottom-2 left-4 z-20">
                                    <h2 class="text-xl font-serif font-bold ${titleColor} leading-tight">${post.title}</h2>
                                </div>
                            </div>
                            <p class="text-gray-600 text-sm whitespace-pre-line">${post.content}</p>
                            ${post.link ? `<div class="mt-4 p-2 bg-blue-50 border border-blue-100 rounded text-xs text-blue-700 truncate"><i class="ph-bold ph-link"></i> ${post.link}</div>` : ''}
                        </div>

                        <div class="max-w-2xl mx-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-bold text-gray-700 flex items-center gap-2"><i class="ph-fill ph-chats-circle text-accent"></i> Moderação (${post.comments.length})</h4>
                            </div>
                            
                            <div class="bg-white p-3 rounded-xl border border-gray-200 mb-4 flex gap-2">
                                <div class="flex-1 relative">
                                    <i class="ph-bold ph-magnifying-glass absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                                    <input type="text" placeholder="Buscar comentário..." 
                                        oninput="window.app.setCommentFilter('filterText', this.value)" 
                                        value="${adminState.postComments.filterText}"
                                        class="w-full bg-gray-50 border border-gray-200 rounded-lg pl-8 p-2 text-xs focus:outline-none focus:border-accent">
                                </div>
                                <select onchange="window.app.setCommentFilter('filterDate', this.value)" class="bg-gray-50 border border-gray-200 rounded-lg p-2 text-xs font-bold text-gray-600 focus:outline-none">
                                    <option value="all" ${adminState.postComments.filterDate === 'all' ? 'selected' : ''}>Todas as Datas</option>
                                    <option value="7" ${adminState.postComments.filterDate === '7' ? 'selected' : ''}>Últimos 7 dias</option>
                                    <option value="30" ${adminState.postComments.filterDate === '30' ? 'selected' : ''}>Últimos 30 dias</option>
                                </select>
                            </div>

                            <div class="space-y-3">
                                ${pagedComments.length > 0 ? pagedComments.map(c => `
                                    <div class="bg-white p-3 rounded-xl border ${c.authorLike ? 'border-accent/50 ring-1 ring-accent/10' : 'border-gray-200'} shadow-sm relative group animate-fade-in">
                                        <div class="flex gap-3">
                                            <img src="${c.avatar}" class="w-8 h-8 rounded-full">
                                            <div class="flex-1">
                                                <div class="flex justify-between">
                                                    <span class="font-bold text-sm text-gray-800">${c.user}</span>
                                                    <span class="text-xs text-gray-400">${c.date}</span>
                                                </div>
                                                <p class="text-sm text-gray-600 mt-1">${c.text}</p>
                                                <div class="flex gap-3 mt-2 opacity-50 group-hover:opacity-100 transition-opacity">
                                                    <button onclick="window.app.toggleAuthorLike(${post.id}, ${c.id})" class="text-xs font-bold ${c.authorLike ? 'text-red-500' : 'text-gray-400 hover:text-accent'}"><i class="ph-bold ${c.authorLike ? 'ph-heart-break' : 'ph-star'}"></i> ${c.authorLike ? 'Tirar Destaque' : 'Destacar'}</button>
                                                    <button onclick="window.app.adminDeleteComment(${post.id}, ${c.id})" class="text-xs font-bold text-gray-400 hover:text-red-500"><i class="ph-bold ph-trash"></i> Remover</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') : '<div class="text-center py-8 text-gray-400 text-xs italic">Nenhum comentário encontrado com estes filtros.</div>'}
                            </div>

                            ${totalPages > 1 ? `
                            <div class="flex justify-center items-center gap-3 mt-6">
                                <button onclick="window.app.changeCommentPage(-1)" class="w-8 h-8 rounded border bg-white hover:bg-gray-50 flex items-center justify-center text-gray-600 disabled:opacity-50" ${adminState.postComments.page === 1 ? 'disabled' : ''}><i class="ph-bold ph-caret-left"></i></button>
                                <span class="text-xs font-bold text-gray-500">Pág ${adminState.postComments.page} de ${totalPages}</span>
                                <button onclick="window.app.changeCommentPage(1)" class="w-8 h-8 rounded border bg-white hover:bg-gray-50 flex items-center justify-center text-gray-600 disabled:opacity-50" ${adminState.postComments.page >= totalPages ? 'disabled' : ''}><i class="ph-bold ph-caret-right"></i></button>
                            </div>
                            ` : ''}

                        </div>
                    </div>
                `;
            },

            openPostModal: (id = null) => {
                const post = id ? DB.posts.find(p => p.id === id) : { 
                    id: '', title: '', category: 'Geral', content: '', 
                    coverType: 'color', coverColor: '1e293b', coverText: '', coverTextColor: 'white',
                    image: '', link: '', allowComments: true, allowLikes: true, status: 'draft' 
                };
                const isEdit = !!id;
                const tabScript = `document.querySelectorAll('.img-tab-btn').forEach(b => { b.classList.remove('text-accent', 'border-accent', 'bg-orange-50'); b.classList.add('text-gray-400', 'border-transparent'); }); event.target.classList.add('text-accent', 'border-accent', 'bg-orange-50'); event.target.classList.remove('text-gray-400', 'border-transparent'); document.querySelectorAll('.img-tab-content').forEach(c => c.classList.add('hidden')); document.getElementById(event.target.dataset.target).classList.remove('hidden'); document.getElementById('post-cover-type').value = event.target.dataset.type;`;

                const body = `
                    <div class="space-y-5 h-[65vh] overflow-y-auto pr-2 custom-scrollbar">
                        <input type="hidden" id="post-id" value="${post.id || ''}">
                        <div class="grid grid-cols-3 gap-4">
                            <div class="col-span-2"><label class="text-xs font-bold text-gray-500 uppercase">Título</label><input type="text" id="post-title" value="${post.title}" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 form-input font-bold text-lg"></div>
                            <div><label class="text-xs font-bold text-gray-500 uppercase">Categoria</label><input type="text" id="post-category" value="${post.category}" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 form-input"></div>
                        </div>

                        <div class="bg-white border border-gray-200 rounded-xl overflow-hidden">
                            <div class="flex border-b border-gray-100">
                                <button onclick="${tabScript}" data-target="tab-color" data-type="color" class="img-tab-btn flex-1 py-3 text-xs font-bold uppercase border-b-2 transition ${post.coverType === 'color' ? 'text-accent border-accent bg-orange-50' : 'text-gray-400 border-transparent'}">Gerar Capa</button>
                                <button onclick="${tabScript}" data-target="tab-upload" data-type="upload" class="img-tab-btn flex-1 py-3 text-xs font-bold uppercase border-b-2 transition ${post.coverType === 'upload' ? 'text-accent border-accent bg-orange-50' : 'text-gray-400 border-transparent'}">Upload</button>
                            </div>
                            <input type="hidden" id="post-cover-type" value="${post.coverType}">
                            
                            <div class="p-5 bg-gray-50 space-y-4">
                                <div>
                                    <label class="text-[10px] font-bold text-gray-500 uppercase mb-1 block">Cor do Texto da Capa (Contraste)</label>
                                    <select id="post-cover-text-color" class="w-full bg-white border border-gray-200 rounded-lg p-2 text-sm">
                                        <option value="white" ${post.coverTextColor === 'white' ? 'selected' : ''}>Texto Branco (Para fundo escuro)</option>
                                        <option value="black" ${post.coverTextColor === 'black' ? 'selected' : ''}>Texto Preto (Para fundo claro)</option>
                                    </select>
                                </div>

                                <div id="tab-color" class="img-tab-content ${post.coverType === 'color' ? '' : 'hidden'} space-y-3">
                                    <div class="flex gap-4 items-center">
                                        <input type="color" id="post-cover-color" value="#${post.coverColor || '1e293b'}" class="h-10 w-10 rounded cursor-pointer border-0 p-0">
                                        <div class="flex-1"><label class="text-[10px] font-bold text-gray-400 uppercase">Texto da Capa</label><input type="text" id="post-cover-text" value="${post.coverText || ''}" placeholder="Título Curto" class="w-full bg-white border border-gray-200 rounded-lg p-2 form-input"></div>
                                    </div>
                                </div>

                                <div id="tab-upload" class="img-tab-content ${post.coverType === 'upload' ? '' : 'hidden'}">
                                    <div class="flex items-center gap-4">
                                        <div class="w-20 h-12 bg-gray-200 rounded overflow-hidden"><img id="preview-post-upload" src="${post.image}" class="w-full h-full object-cover"></div>
                                        <div class="flex-1"><input type="file" accept="image/*" onchange="window.app.handleImageUpload(this, 'preview-post-upload', 'post-upload-data', 2/1)" class="text-xs w-full"><input type="hidden" id="post-upload-data" value="${post.image}"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div><label class="text-xs font-bold text-gray-500 uppercase">Conteúdo</label><textarea id="post-content" rows="6" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 form-input text-sm leading-relaxed">${post.content}</textarea></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Link Externo</label><input type="text" id="post-link" value="${post.link || ''}" placeholder="https://..." class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 form-input"></div>
                        
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 grid grid-cols-2 gap-4">
                            <div><label class="text-xs font-bold text-blue-800 uppercase block mb-2">Permissões</label><div class="space-y-2"><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="post-allow-likes" class="accent-accent" ${post.allowLikes ? 'checked' : ''}> <span class="text-sm text-gray-700">Curtidas</span></label><label class="flex items-center gap-2 cursor-pointer"><input type="checkbox" id="post-allow-comments" class="accent-accent" ${post.allowComments ? 'checked' : ''}> <span class="text-sm text-gray-700">Comentários</span></label></div></div>
                            <div><label class="text-xs font-bold text-blue-800 uppercase block mb-2">Visibilidade</label><select id="post-status" class="w-full bg-white border border-blue-200 rounded-lg p-2 text-sm font-bold text-blue-900"><option value="draft" ${post.status === 'draft' ? 'selected' : ''}>Rascunho</option><option value="published" ${post.status === 'published' ? 'selected' : ''}>Publicado</option></select></div>
                        </div>
                    </div>`;
                const footer = `<button onclick="window.app.closeModal()" class="px-4 py-2 text-gray-500 font-bold">Cancelar</button><button onclick="window.app.savePost(${isEdit})" class="bg-primary text-white px-6 py-2 rounded-lg font-bold shadow-lg">Salvar Post</button>`;
                window.app.openModalGeneric(isEdit ? "Editar Postagem" : "Nova Postagem", body, footer);
            },

            savePost: (isEdit) => {
                const id = document.getElementById('post-id').value;
                const title = document.getElementById('post-title').value;
                const category = document.getElementById('post-category').value;
                const content = document.getElementById('post-content').value;
                const link = document.getElementById('post-link').value;
                const status = document.getElementById('post-status').value;
                const allowLikes = document.getElementById('post-allow-likes').checked;
                const allowComments = document.getElementById('post-allow-comments').checked;

                // Lógica da Imagem
                const coverType = document.getElementById('post-cover-type').value;
                const coverColor = document.getElementById('post-cover-color').value.replace('#', '');
                const coverText = document.getElementById('post-cover-text').value || title;
                const coverTextColor = document.getElementById('post-cover-text-color').value; // <--- PEGANDO O VALOR
                const uploadData = document.getElementById('post-upload-data').value;
                
                let finalImage = '';
                if(coverType === 'color') {
                    // Ajusta a cor do texto do placeholder (se for preto, o placeholder API precisa saber, mas aqui vamos simplificar)
                    // Para o placeholder.co, podemos mudar a cor do texto na URL
                    const txtColorHex = coverTextColor === 'black' ? '000' : 'FFF';
                    finalImage = `https://placehold.co/600x300/${coverColor}/${txtColorHex}?text=${encodeURIComponent(coverText)}`;
                } else {
                    finalImage = uploadData || 'https://placehold.co/600x300?text=Sem+Imagem';
                }

                if(!title) return window.app.toast('Título obrigatório', 'error');

                const postData = {
                    id: isEdit ? parseInt(id) : Date.now(),
                    title, category, status, content, link,
                    coverType, coverColor, coverText, coverTextColor, // <--- SALVANDO
                    image: finalImage,
                    allowLikes, allowComments,
                    date: new Date().toLocaleDateString('pt-BR'),
                    likes: isEdit ? (DB.posts.find(p => p.id == id)?.likes || 0) : 0,
                    likedBy: isEdit ? (DB.posts.find(p => p.id == id)?.likedBy || []) : [],
                    comments: isEdit ? (DB.posts.find(p => p.id == id)?.comments || []) : []
                };

                if(isEdit) {
                    const idx = DB.posts.findIndex(p => p.id == id);
                    if(idx !== -1) DB.posts[idx] = postData;
                } else {
                    DB.posts.unshift(postData);
                }

                window.app.toast('Post salvo com sucesso!', 'success');
                window.app.closeModal();
                if(window.app.selectedPostId === postData.id) window.app.renderAdminPostDetail(postData.id);
                initDashboard();
            },

            deletePost: (id) => {
                window.app.openConfirmModal('Excluir Artigo?', 'Esta ação não pode ser desfeita.', 'danger', 'Excluir', () => {
                    DB.posts = DB.posts.filter(p => p.id !== id);
                    window.app.selectedPostId = null;
                    initDashboard();
                    window.app.toast('Artigo excluído.', 'success');
                });
            },

            toggleAuthorLike: (postId, commentId) => {
                const post = DB.posts.find(p => p.id === postId);
                if(post) {
                    const comment = post.comments.find(c => c.id === commentId);
                    if(comment) {
                        comment.authorLike = !comment.authorLike;
                        window.app.renderAdminPostDetail(postId);
                        window.app.toast(comment.authorLike ? 'Comentário destacado!' : 'Destaque removido.', 'success');
                    }
                }
            },

            // --- CRM: LEADS ---
            submitBudgetRequest: () => {
                // Pega dados do modal de serviço aberto
                const name = document.querySelector('#modal-content input[placeholder="Nome Completo"]').value;
                const email = document.querySelector('#modal-content input[placeholder="E-mail Profissional"]').value;
                const desc = document.querySelector('#modal-content textarea').value;
                const serviceName = document.querySelector('#modal-content h4').innerText;

                if(!name || !email) return window.app.toast('Preencha nome e e-mail!', 'error');

                DB.leads.unshift({
                    id: Date.now(),
                    name, email, desc,
                    service: serviceName,
                    date: new Date().toLocaleDateString('pt-BR'),
                    status: 'pending'
                });

                window.app.toast('Solicitação enviada com sucesso!', 'success');
                window.app.closeModal();
            },

            archiveLead: (id) => {
                const lead = DB.leads.find(l => l.id === id);
                if(lead) {
                    lead.status = 'archived';
                    initDashboard(); // Atualiza a lista
                    window.app.toast('Solicitação arquivada.', 'success');
                }
            },

            // --- ANALYTICS ---
            trackClick: (type) => {
                // Simulação de tracking
                if(type === 'amazon') DB.stats.clicksAmazon++;
                if(type === 'ml') DB.stats.clicksML++;
                if(type === 'shopee') DB.stats.clicksShopee++;
                // Em um app real, aqui enviaria para o backend
            },


            // ==========================================
            // NAVEGAÇÃO & GERAL
            // ==========================================
            changePage: (n) => { currentPage = n; initLivros(); document.getElementById('books-grid').scrollIntoView({ behavior: 'smooth', block: 'start' }); },
            setAdminFilter: (context, key, value) => { adminState[context][key] = value; adminState[context].page = 1; initDashboard(); },
            changeAdminPage: (context, direction) => { adminState[context].page += direction; initDashboard(); },
            sortData: (context, key) => {
                if(adminState[context].sortKey === key) { adminState[context].sortOrder = adminState[context].sortOrder === 'asc' ? 'desc' : 'asc'; } 
                else { adminState[context].sortKey = key; adminState[context].sortOrder = 'asc'; }
                initDashboard();
            },
            toggleFavorite: (id) => {
                if (favorites.includes(id)) { favorites = favorites.filter(favId => favId !== id); window.app.toast('Removido dos favoritos', 'success'); } 
                else { favorites.push(id); window.app.toast('Adicionado aos favoritos!', 'success'); }
                localStorage.setItem('user_favorites', JSON.stringify(favorites));
                if (window.location.hash.includes('livros')) initLivros();
                if (window.location.hash.includes('livro/')) initBookDetails(id);
            },

            // ==========================================
            // CMS: HOME & PERSONALIZAÇÃO
            // ==========================================
            
            // --- Helpers Dropdown Home ---
            toggleDropdown: (id) => { const el = document.getElementById(id); if(el) el.classList.toggle('hidden'); },
            selectHeroBook: (bookId, bookTitle) => { document.getElementById('config-hero-input').value = bookId; document.getElementById('config-hero-btn-text').innerText = bookTitle; document.getElementById('custom-dropdown-list').classList.add('hidden'); },

            // --- Modal Config Home ---
            openHomeConfigModal: () => {
                const currentHeroBook = DB.books.find(b => b.id === DB.homeConfig.heroBookId) || DB.books[0];
                const dropdownItems = DB.books.map(b => `<div onclick="window.app.selectHeroBook('${b.id}', '${b.title}')" class="p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-50 flex items-center gap-3 transition"><img src="${b.cover}" class="w-8 h-10 object-cover rounded shadow-sm"><span class="text-sm font-bold text-gray-700">${b.title}</span></div>`).join('');
                const isChecked = (id) => DB.homeConfig.highlights.includes(id) ? 'checked' : '';
                const highlightsList = [...DB.books.map(b => ({id: b.id, type: 'Livro', name: b.title})), ...DB.services.map(s => ({id: s.id, type: 'Serviço', name: s.name}))].map(item => `<label class="flex items-center gap-3 p-3 border border-gray-100 rounded-lg hover:bg-gray-50 cursor-pointer transition"><input type="checkbox" name="home-highlights" value="${item.id}" ${isChecked(item.id)} class="w-5 h-5 text-accent rounded focus:ring-accent"><div><span class="text-xs font-bold uppercase text-gray-400 block">${item.type}</span><span class="text-sm font-bold text-gray-700">${item.name}</span></div></label>`).join('');
                
                const body = `<div class="space-y-8 animate-fade-in custom-scrollbar max-h-[60vh] overflow-y-auto pr-2 pb-10"><div class="bg-gray-50 p-6 rounded-2xl border border-gray-200"><div class="flex items-center gap-3 mb-2"><div class="w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center font-bold text-xs">1</div><h4 class="font-bold text-primary">Destaque Principal (Hero)</h4></div><p class="text-xs text-gray-500 mb-6 ml-11">Este livro aparecerá com destaque máximo no topo.</p><div class="relative ml-11 mb-6"><input type="hidden" id="config-hero-input" value="${currentHeroBook.id}"><button onclick="window.app.toggleDropdown('custom-dropdown-list')" class="w-full bg-white border border-gray-300 rounded-xl p-4 flex items-center justify-between shadow-sm hover:border-accent transition group"><span id="config-hero-btn-text" class="font-bold text-gray-700">${currentHeroBook.title}</span><i class="ph-bold ph-caret-down text-gray-400 group-hover:text-accent"></i></button><div id="custom-dropdown-list" class="hidden absolute top-full left-0 w-full bg-white border border-gray-200 rounded-xl shadow-xl mt-2 z-50 max-h-48 overflow-y-auto custom-scrollbar">${dropdownItems}</div></div><div class="ml-11 flex items-center justify-between bg-white p-4 rounded-xl border border-gray-200"><div><span class="font-bold text-gray-800 text-sm block">Selo "Último Lançamento"</span><span class="text-xs text-gray-400">Exibir badge pulsante acima do título?</span></div><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="config-launch-badge" class="sr-only peer" ${DB.homeConfig.showLaunchBadge ? 'checked' : ''}><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label></div></div><div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm"><div class="flex items-center gap-3 mb-4"><div class="w-8 h-8 rounded-full bg-accent text-white flex items-center justify-center font-bold text-xs">2</div><h4 class="font-bold text-primary">Em Destaque (Highlights)</h4></div><div class="grid grid-cols-1 md:grid-cols-2 gap-3 ml-11">${highlightsList}</div></div><div class="bg-blue-50 p-6 rounded-2xl border border-blue-100"><div class="flex items-center gap-3 mb-4"><div class="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-xs">3</div><h4 class="font-bold text-primary">Frase de Efeito</h4></div><div class="space-y-3 ml-11"><textarea id="config-quote-text" rows="2" class="w-full bg-white border border-blue-200 rounded-lg p-3 text-sm font-serif italic text-gray-700">${DB.homeConfig.quote.text}</textarea><input type="text" id="config-quote-author" value="${DB.homeConfig.quote.author}" class="w-full bg-white border border-blue-200 rounded-lg p-2 text-sm font-bold text-gray-700"></div></div></div>`;
                const footer = `<button onclick="window.app.closeModal()" class="px-4 py-2 text-gray-500 font-bold text-sm">Cancelar</button><button onclick="window.app.saveHomeConfig()" class="bg-primary text-white px-6 py-2 rounded-lg font-bold shadow-lg">Salvar</button>`;
                window.app.openModalGeneric("Personalizar Home", body, footer);
            },
            saveHomeConfig: () => {
                const heroId = document.getElementById('config-hero-input').value;
                const showLaunch = document.getElementById('config-launch-badge').checked;
                const quoteText = document.getElementById('config-quote-text').value;
                const quoteAuthor = document.getElementById('config-quote-author').value;
                const checkboxes = document.querySelectorAll('input[name="home-highlights"]:checked');
                const selectedHighlights = Array.from(checkboxes).map(cb => cb.value);
                if (selectedHighlights.length === 0) return window.app.toast('Selecione pelo menos 1 destaque.', 'error');
                if (selectedHighlights.length > 4) return window.app.toast('Máximo de 4 destaques.', 'error');
                DB.homeConfig = { heroBookId: heroId, showLaunchBadge: showLaunch, highlights: selectedHighlights, quote: { text: quoteText, author: quoteAuthor } };
                window.app.toast('Home atualizada!', 'success'); window.app.closeModal();
            },

            // ==========================================
            // CMS: SOBRE (NOVA IMPLEMENTAÇÃO)
            // ==========================================
            openAboutConfigModal: () => {
                const renderTimelineInputs = () => {
                    return (DB.author.timeline || []).map((t, idx) => `
                        <div class="flex gap-3 items-start bg-gray-50 p-3 rounded-lg border border-gray-200 group hover:border-accent transition">
                            <div class="w-20 pt-2">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Ano</label>
                                <input type="text" value="${t.year}" class="w-full bg-white border border-gray-200 rounded p-1 text-sm font-bold text-center">
                            </div>
                            <div class="flex-1">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Evento</label>
                                <input type="text" value="${t.title}" class="w-full bg-white border border-gray-200 rounded p-1 text-sm font-bold mb-1">
                                <textarea rows="2" class="w-full bg-white border border-gray-200 rounded p-1 text-xs text-gray-600 resize-none">${t.desc}</textarea>
                            </div>
                            <button onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 p-2 hover:bg-red-50 rounded mt-4"><i class="ph-bold ph-trash"></i></button>
                        </div>
                    `).join('');
                };

                const body = `
                    <div class="space-y-6 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                        <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm">
                            <h4 class="font-bold text-primary mb-4 flex items-center gap-2"><i class="ph-fill ph-identification-card text-accent"></i> Perfil do Autor</h4>
                            
                            <div class="mb-6 flex gap-4 items-center bg-gray-50 p-3 rounded-lg border border-gray-200">
                                <img id="preview-author-main" src="${DB.author.avatar}" class="w-16 h-16 rounded-full object-cover border-2 border-white shadow">
                                <div class="flex-1">
                                    <label class="text-xs font-bold text-gray-500 uppercase block mb-1">Foto Principal</label>
                                    <input type="file" accept="image/*" onchange="window.app.handleImageUpload(this, 'preview-author-main', 'cfg-author-avatar', 1)" class="text-xs w-full text-gray-500 file:mr-2 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-primary file:text-white hover:file:bg-slate-700">
                                    <input type="hidden" id="cfg-author-avatar" value="${DB.author.avatar}">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div><label class="text-xs font-bold text-gray-500 uppercase">Nome de Exibição</label><input type="text" id="cfg-author-name" value="${DB.author.name}" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 form-input font-bold"></div>
                                <div><label class="text-xs font-bold text-gray-500 uppercase">Cargo / Tagline</label><input type="text" id="cfg-author-role" value="${DB.author.role}" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 form-input"></div>
                            </div>
                            <div class="mb-4"><label class="text-xs font-bold text-gray-500 uppercase">Biografia Principal</label><textarea id="cfg-author-bio" rows="4" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 form-input text-sm leading-relaxed">${DB.author.bio}</textarea></div>
                        </div>
                        
                        <div class="bg-orange-50 p-5 rounded-xl border border-orange-100">
                            <h4 class="font-bold text-orange-800 mb-4 flex items-center gap-2"><i class="ph-fill ph-image text-orange-600"></i> Foto "Polaroid" (Secundária)</h4>
                            
                            <div class="mb-4 flex gap-4 items-center bg-white p-3 rounded-lg border border-orange-200">
                                <img id="preview-author-sec" src="${DB.author.secondaryImage}" class="w-16 h-16 rounded object-cover border border-gray-200 shadow">
                                <div class="flex-1">
                                    <label class="text-xs font-bold text-orange-700 uppercase block mb-1">Imagem Polaroid</label>
                                    <input type="file" accept="image/*" onchange="window.app.handleImageUpload(this, 'preview-author-sec', 'cfg-sec-img', 4/3)" class="text-xs w-full text-gray-500 file:mr-2 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-orange-600 file:text-white hover:file:bg-orange-700">
                                    <input type="hidden" id="cfg-sec-img" value="${DB.author.secondaryImage}">
                                </div>
                            </div>

                            <div><label class="text-xs font-bold text-orange-700 uppercase">Legenda (Manuscrita)</label><input type="text" id="cfg-sec-caption" value="${DB.author.secondaryCaption}" class="w-full bg-white border border-orange-200 rounded-lg p-2 form-input font-hand text-xl text-gray-600"></div>
                        </div>
                        <div class="bg-gray-50 p-5 rounded-xl border border-gray-200">
                            <div class="flex items-center justify-between mb-4">
                                <h4 class="font-bold text-primary flex items-center gap-2"><i class="ph-fill ph-path text-accent"></i> Linha do Tempo</h4>
                                <button onclick="window.app.addTimelineItem()" class="text-xs bg-primary text-white px-3 py-1 rounded hover:bg-slate-700 transition font-bold">+ Adicionar Evento</button>
                            </div>
                            <div id="config-timeline-list" class="space-y-3">${renderTimelineInputs()}</div>
                        </div>
                    </div>
                `;

                const footer = `<button onclick="window.app.closeModal()" class="px-4 py-2 text-gray-500 font-bold text-sm">Cancelar</button><button onclick="window.app.saveAboutConfig()" class="bg-primary text-white px-6 py-2 rounded-lg font-bold shadow-lg flex items-center gap-2"><i class="ph-bold ph-floppy-disk"></i> Salvar</button>`;
                window.app.openModalGeneric("Editor de Narrativa", body, footer);
            },

            saveAboutConfig: () => {
                DB.author.name = document.getElementById('cfg-author-name').value;
                DB.author.role = document.getElementById('cfg-author-role').value;
                DB.author.bio = document.getElementById('cfg-author-bio').value;
                DB.author.avatar = document.getElementById('cfg-author-avatar').value;
                DB.author.secondaryImage = document.getElementById('cfg-sec-img').value;
                DB.author.secondaryCaption = document.getElementById('cfg-sec-caption').value;
            
                const newTimeline = [];
                const container = document.getElementById('config-timeline-list');
                if(container) {
                    for(let block of container.children) {
                        const inputs = block.querySelectorAll('input, textarea');
                        if(inputs.length >= 3) {
                            newTimeline.push({ year: inputs[0].value, title: inputs[1].value, desc: inputs[2].value });
                        }
                    }
                }
                newTimeline.sort((a, b) => parseInt(a.year) - parseInt(b.year));
                DB.author.timeline = newTimeline;
            
                window.app.toast('Biografia atualizada!', 'success');
                initAbout(); // Atualiza a tela se estiver nela
                window.app.closeModal();
            },
            
            addTimelineItem: () => {
                const container = document.getElementById('config-timeline-list');
                const div = document.createElement('div');
                div.className = "flex gap-3 items-start bg-white p-3 rounded-lg border-2 border-accent/20 animate-fade-in";
                div.innerHTML = `<div class="w-20 pt-2"><label class="text-[10px] font-bold text-accent uppercase">Ano</label><input type="text" value="${new Date().getFullYear()}" class="w-full bg-gray-50 border border-gray-200 rounded p-1 text-sm font-bold text-center text-accent"></div><div class="flex-1"><label class="text-[10px] font-bold text-accent uppercase">Novo Evento</label><input type="text" placeholder="Título..." class="w-full bg-gray-50 border border-gray-200 rounded p-1 text-sm font-bold mb-1 focus:border-accent outline-none"><textarea rows="2" placeholder="Descrição..." class="w-full bg-gray-50 border border-gray-200 rounded p-1 text-xs text-gray-600 resize-none focus:border-accent outline-none"></textarea></div><button onclick="this.parentElement.remove()" class="text-red-400 hover:text-red-600 p-2 hover:bg-red-50 rounded mt-4"><i class="ph-bold ph-trash"></i></button>`;
                container.appendChild(div);
                div.scrollIntoView({ behavior: 'smooth' });
            },

            // ==========================================
            // HELPERS: UI DE SERVIÇOS (ÍCONE E COR)
            // ==========================================
            filterIconGrid: (term) => {
                const items = document.querySelectorAll('.icon-grid-item');
                items.forEach(item => {
                    const iconName = item.dataset.icon;
                    if(iconName.includes(term.toLowerCase())) { item.classList.remove('hidden'); } else { item.classList.add('hidden'); }
                });
            },
            selectServiceIcon: (iconName) => {
                document.getElementById('service-icon-input').value = iconName;
                document.getElementById('icon-preview-display').className = `ph-fill ${iconName} text-2xl text-primary`;
                document.getElementById('icon-picker-modal').classList.add('hidden');
            },
            selectServiceTheme: (themeName) => {
                document.getElementById('service-theme-input').value = themeName;
                document.querySelectorAll('.theme-dot').forEach(el => {
                    if(el.dataset.theme === themeName) { el.classList.add('ring-2', 'ring-offset-2', 'ring-gray-400', 'scale-110'); } 
                    else { el.classList.remove('ring-2', 'ring-offset-2', 'ring-gray-400', 'scale-110'); }
                });
            },
            toggleIconPicker: () => {
                const picker = document.getElementById('icon-picker-modal');
                picker.classList.toggle('hidden');
                if(!picker.classList.contains('hidden')) { document.getElementById('icon-search-input').focus(); }
            },

            // ==========================================
            // SISTEMA DE CONFIRMAÇÃO & MODAL GENÉRICO
            // ==========================================
            openConfirmModal: (title, message, iconType, confirmText, callback) => {
                window.app._pendingConfirmAction = callback;
                const isDanger = iconType === 'danger';
                const colorClass = isDanger ? 'text-red-500 bg-red-50 border-red-100' : 'text-amber-500 bg-amber-50 border-amber-100';
                const iconName = isDanger ? 'ph-trash' : 'ph-warning';
                const btnClass = isDanger ? 'bg-red-500 hover:bg-red-600' : 'bg-primary hover:bg-slate-800';
                const body = `<div class="flex flex-col items-center text-center animate-fade-in"><div class="w-20 h-20 rounded-full flex items-center justify-center mb-6 ${colorClass} border-4 shadow-sm"><i class="ph-fill ${iconName} text-4xl"></i></div><h4 class="text-2xl font-bold text-gray-800 mb-2 font-serif">${title}</h4><p class="text-gray-500 text-sm leading-relaxed max-w-xs mx-auto">${message}</p></div>`;
                const footer = `<div class="flex gap-3 w-full justify-center"><button onclick="window.app.closeModal()" class="flex-1 py-3 px-4 rounded-xl border border-gray-200 text-gray-600 font-bold text-sm hover:bg-gray-50 transition">Cancelar</button><button onclick="window.app.executeConfirm()" class="flex-1 py-3 px-4 rounded-xl text-white font-bold text-sm shadow-lg transition transform hover:-translate-y-0.5 ${btnClass}">${confirmText}</button></div>`;
                window.app.openModalGeneric(" ", body, footer);
            },
            executeConfirm: () => { if (window.app._pendingConfirmAction) { window.app._pendingConfirmAction(); window.app._pendingConfirmAction = null; } window.app.closeModal(); },
            openModalGeneric: (title, bodyHTML, footerHTML) => { document.getElementById('modal-title').innerText = title; document.getElementById('modal-body').innerHTML = bodyHTML; document.getElementById('modal-footer').innerHTML = footerHTML; const modal = document.getElementById('modal-overlay'); const content = document.getElementById('modal-content'); modal.classList.remove('hidden'); setTimeout(() => { modal.classList.remove('opacity-0'); content.classList.remove('opacity-0', 'scale-95'); }, 10); },
            closeModal: () => { const modal = document.getElementById('modal-overlay'); const content = document.getElementById('modal-content'); modal.classList.add('opacity-0'); content.classList.add('opacity-0', 'scale-95'); setTimeout(() => modal.classList.add('hidden'), 300); },

            // ==========================================
            // CRUD: LIVROS
            // ==========================================
            deleteBook: (id) => { window.app.openConfirmModal('Excluir Livro?', 'Você tem certeza? Essa ação removerá a obra da sua biblioteca permanentemente.', 'danger', 'Sim, Excluir', () => { DB.books = DB.books.filter(b => b.id !== id); if(DB.books.length % adminState.itemsPerPage === 0 && adminState.books.page > 1) { adminState.books.page--; } initDashboard(); window.app.toast('Livro excluído com sucesso.', 'success'); }); },

            setCommentFilter: (key, value) => {
                adminState.postComments[key] = value;
                adminState.postComments.page = 1; // Reseta para pág 1
                if(window.app.selectedPostId) window.app.renderAdminPostDetail(window.app.selectedPostId);
            },
            changeCommentPage: (dir) => {
                adminState.postComments.page += dir;
                if(window.app.selectedPostId) window.app.renderAdminPostDetail(window.app.selectedPostId);
            },

            // --- CONTROLE DE COMENTÁRIOS (PÚBLICO) ---
            loadMoreComments: (postId) => {
                const current = publicState.expandedComments[postId] || 3;
                // Aumenta 5, mas trava em 20
                let next = current + 5;
                if (next > 20) next = 20; 
                
                // Se já estiver em 20, ou se o próximo passo cobrir todos, mostra todos (ou mantém 20)
                // O pedido foi "limite de 20". Se tiver mais que 20, o botão some ou leva pra outro lugar?
                // Vou travar em 20 e mudar o texto se houver mais.
                
                publicState.expandedComments[postId] = next;
                initCommunity();
            },
            
            // ATENÇÃO: Adicione isso à função selectAdminPost para resetar o estado dos comentários ao trocar de post
            selectAdminPost: (id) => {
                window.app.selectedPostId = id;
                // Reseta paginação/filtros de comentário ao trocar de post
                adminState.postComments.page = 1;
                adminState.postComments.filterText = '';
                adminState.postComments.filterDate = 'all';
                initDashboard();
            },

            openBookModal: (id = null) => {
                const book = id ? DB.books.find(b => b.id === id) : { id: '', title: '', genre: 'Ficção', price: '', promoPrice: '', cover: 'https://placehold.co/300x450/333/FFF?text=Sem+Capa', synopsis: '', coverSynopsis: '', isPromotion: false, active: true, linkAmazon: '', linkML: '', linkShopee: '' };
                const isEdit = !!id;
                const toggleScript = `if(this.checked){document.getElementById('promo-input-container').classList.remove('hidden');document.getElementById('book-promo-price').focus();}else{document.getElementById('promo-input-container').classList.add('hidden');document.getElementById('book-promo-price').value='';}`;
                
                const body = `
                <div class="space-y-4 h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                    <input type="hidden" id="book-id" value="${book.id || ''}">
                    
                    <div class="flex gap-4 items-start bg-gray-50 p-4 rounded-xl border border-gray-200">
                        <div class="w-24 h-36 bg-gray-200 rounded shadow-sm overflow-hidden flex-shrink-0">
                            <img id="preview-book-cover" src="${book.cover}" class="w-full h-full object-cover">
                        </div>
                        <div class="flex-1">
                            <label class="text-xs font-bold text-primary uppercase block mb-2">Capa do Livro</label>
                            <p class="text-xs text-gray-400 mb-3">Recomendado: Proporção 2:3 (Ex: 600x900px)</p>
                            <input type="file" accept="image/*" onchange="window.app.handleImageUpload(this, 'preview-book-cover', 'book-cover', 2/3)" class="text-xs w-full text-gray-500 file:mr-2 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-bold file:bg-white file:border-gray-200 file:text-primary file:shadow-sm hover:file:bg-gray-50 cursor-pointer">
                            <input type="hidden" id="book-cover" value="${book.cover}">
                        </div>
                    </div>

                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <div><label class="text-xs font-bold text-gray-500 uppercase block">Visibilidade</label><span class="text-sm font-bold text-primary">O livro está visível no site?</span></div>
                        <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="book-active" class="sr-only peer" ${book.active ? 'checked' : ''}><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2"><label class="text-xs font-bold text-gray-500 uppercase">Título da Obra</label><input type="text" id="book-title" value="${book.title}" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 form-input font-bold text-gray-700"></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Gênero</label><select id="book-genre" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 form-input"><option value="Ficção" ${book.genre === 'Ficção' ? 'selected' : ''}>Ficção</option><option value="Fantasia" ${book.genre === 'Fantasia' ? 'selected' : ''}>Fantasia</option><option value="Terror" ${book.genre === 'Terror' ? 'selected' : ''}>Terror</option><option value="Romance" ${book.genre === 'Romance' ? 'selected' : ''}>Romance</option></select></div>
                        <div><label class="text-xs font-bold text-gray-500 uppercase">Preço Original (R$)</label><input type="number" step="0.01" id="book-price" value="${book.price}" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 form-input"></div>
                    </div>
                    
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                        <label class="text-xs font-bold text-primary uppercase flex justify-between">Resumo da Capa (Home)<span class="text-gray-400 font-normal text-[10px]">Máx 65 caracteres</span></label>
                        <input type="text" id="book-cover-synopsis" value="${book.coverSynopsis || ''}" maxlength="65" placeholder="Frase de impacto para a Home..." class="w-full bg-white border border-gray-300 rounded-lg p-2 mt-1 form-input text-sm">
                    </div>
                    
                    <div class="bg-orange-50 p-4 rounded-xl border border-orange-100 transition-all">
                        <div class="flex items-center justify-between mb-2">
                            <div><h4 class="font-bold text-orange-800 text-sm">Modo Promoção</h4><p class="text-xs text-orange-600">Ativa oferta especial na página.</p></div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="book-promo" class="sr-only peer" onchange="${toggleScript}" ${book.isPromotion ? 'checked' : ''}><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent"></div></label>
                        </div>
                        <div id="promo-input-container" class="${book.isPromotion ? '' : 'hidden'} animate-fade-in mt-3 border-t border-orange-200 pt-3">
                            <label class="text-xs font-bold text-orange-700 uppercase">Preço Promocional (R$)</label>
                            <input type="number" step="0.01" id="book-promo-price" value="${book.promoPrice || ''}" placeholder="Ex: 19.90" class="w-full bg-white border border-orange-200 rounded-lg p-2 form-input text-orange-900 font-bold">
                        </div>
                    </div>
                    
                    <div><label class="text-xs font-bold text-gray-500 uppercase">Sinopse Completa</label><textarea id="book-synopsis" rows="4" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 form-input text-sm leading-relaxed">${book.synopsis || ''}</textarea></div>
                    
                    <div class="border-t border-gray-100 pt-4">
                        <h4 class="font-bold text-gray-700 mb-3 text-sm">Links de Venda</h4>
                        <div class="grid grid-cols-1 gap-2">
                            <input type="text" id="link-amazon" value="${book.linkAmazon}" placeholder="Link Amazon" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-xs">
                            <input type="text" id="link-ml" value="${book.linkML}" placeholder="Link Mercado Livre" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-xs">
                            <input type="text" id="link-shopee" value="${book.linkShopee}" placeholder="Link Shopee" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-xs">
                        </div>
                    </div>
                </div>`;
                
                const footer = `<button onclick="window.app.closeModal()" class="px-4 py-2 text-gray-500 font-bold text-sm hover:text-gray-800 transition">Cancelar</button><button onclick="window.app.saveBook(${isEdit})" class="bg-primary hover:bg-slate-800 text-white px-6 py-2 rounded-lg font-bold shadow-lg transition flex items-center gap-2"><i class="ph-bold ph-floppy-disk"></i> Salvar</button>`;
                window.app.openModalGeneric(isEdit ? "Editar Livro" : "Cadastrar Novo Livro", body, footer);
            },

            saveBook: (isEdit) => {
                const id = document.getElementById('book-id').value; const title = document.getElementById('book-title').value; const genre = document.getElementById('book-genre').value; const price = parseFloat(document.getElementById('book-price').value); const cover = document.getElementById('book-cover').value || 'https://placehold.co/300x450/333/FFF?text=Capa'; const synopsis = document.getElementById('book-synopsis').value; const coverSynopsis = document.getElementById('book-cover-synopsis').value;
                const active = document.getElementById('book-active').checked; const isPromotion = document.getElementById('book-promo').checked; const linkAmazon = document.getElementById('link-amazon').value; const linkML = document.getElementById('link-ml').value; const linkShopee = document.getElementById('link-shopee').value; let promoPrice = null;
                if(!title || isNaN(price) || price <= 0) return window.app.toast('Dados inválidos', 'error');
                if (isPromotion) { promoPrice = parseFloat(document.getElementById('book-promo-price').value); if (isNaN(promoPrice) || promoPrice <= 0) return window.app.toast('Preço promocional inválido', 'error'); if (promoPrice >= price) return window.app.toast('Preço maior que o original', 'error'); }
                const bookData = { id: isEdit ? id : Date.now().toString(), title, genre, price, cover, synopsis, coverSynopsis, active, isPromotion, promoPrice, linkAmazon, linkML, linkShopee };
                if(isEdit) { const index = DB.books.findIndex(b => b.id === id); if (index !== -1) { DB.books[index] = bookData; window.app.toast('Livro atualizado!', 'success'); } } else { DB.books.unshift(bookData); window.app.toast('Novo livro cadastrado!', 'success'); }
                initDashboard(); window.app.closeModal();
            },

            setAdminTab: (tab) => {
                    adminState.currentTab = tab;
                    initDashboard();
                },
                archiveLead: (id) => {
                    const lead = DB.leads.find(l => l.id === id);
                    if(lead) { lead.status = 'archived'; initDashboard(); window.app.toast('Solicitação arquivada.', 'success'); }
                },
                // Rastreio de cliques nos botões de compra
                trackClick: (type) => {
                    if(type === 'amazon') DB.stats.clicksAmazon++;
                    if(type === 'ml') DB.stats.clicksML++;
                    if(type === 'shopee') DB.stats.clicksShopee++;
                },
                // Salvar novo pedido de orçamento (Modal Serviços)
                submitBudgetRequest: () => {
                    const name = document.querySelector('#modal-content input[placeholder="Nome Completo"]').value;
                    const email = document.querySelector('#modal-content input[placeholder="E-mail Profissional"]').value;
                    const desc = document.querySelector('#modal-content textarea').value;
                    const serviceName = document.querySelector('#modal-content h4').innerText;
                    if(!name || !email) return window.app.toast('Preencha nome e e-mail!', 'error');
                    DB.leads.unshift({ id: Date.now(), name, email, desc, service: serviceName, date: new Date().toLocaleDateString('pt-BR'), status: 'pending' });
                    window.app.toast('Solicitação enviada!', 'success'); window.app.closeModal();
                },

            // ==========================================
            // CRUD: SERVIÇOS
            // ==========================================
            deleteService: (id) => { window.app.openConfirmModal('Remover Serviço?', 'Este serviço não estará mais visível para contratação. Deseja continuar?', 'danger', 'Remover', () => { DB.services = DB.services.filter(s => s.id !== id); if(DB.services.length % adminState.itemsPerPage === 0 && adminState.services.page > 1) { adminState.services.page--; } initDashboard(); window.app.toast('Serviço removido.', 'success'); }); },
            openServiceEditModal: (id = null) => {
                let randomTheme = 'default'; let randomIcon = 'ph-star-four';
                if (!id) { const themes = Object.keys(THEMES); const icons = ICON_LIBRARY; randomTheme = themes[Math.floor(Math.random() * themes.length)]; randomIcon = icons[Math.floor(Math.random() * icons.length)]; }
                const s = id ? DB.services.find(x => x.id === id) : { id: '', name: '', price: '', unit: '', description: '', active: true, isPromotion: false, promoPrice: '', icon: randomIcon, theme: randomTheme };
                const isEdit = !!id;
                const promoToggle = `if(this.checked){document.getElementById('serv-promo-container').classList.remove('hidden');}else{document.getElementById('serv-promo-container').classList.add('hidden');document.getElementById('serv-promo-price').value='';}`;
                const iconGridHTML = ICON_LIBRARY.map(ic => `<div onclick="window.app.selectServiceIcon('${ic}')" class="icon-grid-item p-3 rounded-lg hover:bg-gray-100 cursor-pointer flex items-center justify-center transition" data-icon="${ic}" title="${ic}"><i class="ph-fill ${ic} text-2xl text-gray-600 hover:text-primary"></i></div>`).join('');
                const colorDotsHTML = Object.entries(THEMES).map(([key, val]) => `<div onclick="window.app.selectServiceTheme('${key}')" data-theme="${key}" class="theme-dot w-8 h-8 rounded-full cursor-pointer transition-all hover:scale-110 ${val.dot} ${s.theme === key ? 'ring-2 ring-offset-2 ring-gray-400 scale-110' : ''}" title="${val.name}"></div>`).join('');
                const body = `<div class="space-y-5 h-[60vh] overflow-y-auto pr-2 custom-scrollbar"><input type="hidden" id="service-id" value="${s.id || ''}"><div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg border border-gray-200"><span class="text-xs font-bold text-gray-500 uppercase">Status do Serviço</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="service-active" class="sr-only peer" ${s.active ? 'checked' : ''}><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label></div><div class="space-y-4"><div><label class="text-xs font-bold text-gray-500 uppercase">Nome do Serviço</label><input type="text" id="service-name" value="${s.name}" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 form-input font-bold text-gray-700"></div><div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-gray-500 uppercase">Preço Base (R$)</label><input type="number" step="0.01" id="service-price" value="${s.price}" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 form-input"></div><div><label class="text-xs font-bold text-gray-500 uppercase">Unidade</label><input type="text" id="service-unit" value="${s.unit || ''}" placeholder="Ex: p/ hora" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 form-input"></div></div></div><div class="bg-gray-50 p-5 rounded-xl border border-gray-200"><div class="mb-4 border-b border-gray-200 pb-2"><span class="font-bold text-gray-800 text-sm flex items-center gap-2"><i class="ph-fill ph-paint-brush text-accent"></i> Identidade Visual</span></div><div class="space-y-5"><div><label class="text-xs font-bold text-gray-500 uppercase mb-2 block">Ícone Principal</label><input type="hidden" id="service-icon-input" value="${s.icon}"><button onclick="window.app.toggleIconPicker()" class="w-full bg-white border border-gray-300 rounded-lg p-3 flex items-center justify-between hover:bg-gray-50 transition group"><div class="flex items-center gap-3"><div class="w-8 h-8 bg-gray-100 rounded flex items-center justify-center"><i id="icon-preview-display" class="ph-fill ${s.icon} text-xl text-primary"></i></div><span class="text-sm font-bold text-gray-600 group-hover:text-primary">Selecionar Ícone...</span></div><i class="ph-bold ph-caret-down text-gray-400"></i></button><div id="icon-picker-modal" class="hidden mt-2 bg-white border border-gray-200 rounded-xl shadow-lg p-4 animate-fade-in"><input type="text" id="icon-search-input" oninput="window.app.filterIconGrid(this.value)" placeholder="Buscar..." class="w-full bg-gray-50 border border-gray-200 rounded-lg p-2 text-sm mb-3 focus:outline-none focus:border-accent"><div class="grid grid-cols-6 gap-2 max-h-40 overflow-y-auto custom-scrollbar">${iconGridHTML}</div></div></div><div><label class="text-xs font-bold text-gray-500 uppercase mb-3 block">Tema do Card</label><input type="hidden" id="service-theme-input" value="${s.theme}"><div class="flex gap-4 flex-wrap">${colorDotsHTML}</div></div></div></div><div class="bg-blue-50 p-4 rounded-xl border border-blue-100"><div class="flex items-center justify-between mb-2"><span class="font-bold text-blue-800 text-sm">Preço Promocional?</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="service-promo" class="sr-only peer" onchange="${promoToggle}" ${s.isPromotion ? 'checked' : ''}><div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label></div><div id="serv-promo-container" class="${s.isPromotion ? '' : 'hidden'} mt-2"><input type="number" step="0.01" id="serv-promo-price" value="${s.promoPrice || ''}" placeholder="Novo Valor" class="w-full bg-white border border-blue-200 rounded-lg p-2 form-input text-blue-900 font-bold"></div></div><div><label class="text-xs font-bold text-gray-500 uppercase">Descrição</label><textarea id="service-desc" rows="3" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 form-input text-sm">${s.description}</textarea></div></div>`;
                const footer = `<button onclick="window.app.closeModal()" class="px-4 py-2 text-gray-500">Cancelar</button><button onclick="window.app.saveService(${isEdit})" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">Salvar</button>`;
                window.app.openModalGeneric(isEdit ? "Editar Serviço" : "Novo Serviço", body, footer);
            },
            saveService: (isEdit) => {
                const id = document.getElementById('service-id').value; const name = document.getElementById('service-name').value; const price = parseFloat(document.getElementById('service-price').value); const unit = document.getElementById('service-unit').value; const description = document.getElementById('service-desc').value; const active = document.getElementById('service-active').checked; const isPromotion = document.getElementById('service-promo').checked;
                const icon = document.getElementById('service-icon-input').value || 'ph-star-four'; const theme = document.getElementById('service-theme-input').value || 'default';
                let promoPrice = null;
                if(!name || isNaN(price) || price <= 0) return window.app.toast('Dados inválidos', 'error');
                if (isPromotion) { promoPrice = parseFloat(document.getElementById('serv-promo-price').value); if (isNaN(promoPrice) || promoPrice <= 0 || promoPrice >= price) return window.app.toast('Preço promocional inválido', 'error'); }
                const data = { id: isEdit ? id : 'S' + Date.now(), name, price, unit, description, active, isPromotion, promoPrice, icon, theme };
                if(isEdit) { const idx = DB.services.findIndex(s => s.id === id); if (idx !== -1) DB.services[idx] = data; } else { DB.services.push(data); }
                window.app.toast('Serviço salvo!', 'success'); initDashboard(); window.app.closeModal();
            },

            // ==========================================
            // AUTH & PUBLIC INTERACTION
            // ==========================================
            logout: () => { window.app.openConfirmModal('Sair do Painel', 'Deseja encerrar sua sessão administrativa?', 'warning', 'Sair Agora', () => { isAdmin = false; localStorage.removeItem('isAdmin'); window.location.hash = '#/'; router(); window.app.toast('Você saiu do sistema.', 'success'); }); },
            connectGoogle: () => { user = { name: "Visitante", avatar: "https://placehold.co/40x40/d97706/FFF?text=Eu" }; localStorage.setItem('user', JSON.stringify(user)); initCommunity(); window.app.toast('Conectado como Visitante', 'success'); },
            postComment: () => { const text = document.getElementById('new-comment').value; if(text.trim()) { DB.comments.unshift({ id: Date.now(), user: user.name, avatar: user.avatar, text: text, date: "Agora mesmo" }); initCommunity(); window.app.toast('Comentário publicado!', 'success'); } },
            handleLogin: () => { const e = document.getElementById('email').value; const p = document.getElementById('password').value; if(e === 'admin@ronaldo.com' && p === 'admin') { isAdmin = true; localStorage.setItem('isAdmin', 'true'); window.location.hash = '#/painel'; router(); window.app.toast('Bem-vindo, Chefe!', 'success'); } else { window.app.toast('Credenciais inválidas', 'error'); } },
            
            openServiceModal: (id) => { 
                const s = DB.services.find(x => x.id === id); 
                const body = `
                    <div class="space-y-6 animate-fade-in">
                        <div class="bg-gradient-to-r from-gray-50 to-white p-6 rounded-xl border border-gray-100 shadow-sm relative overflow-hidden">
                            <div class="absolute right-0 top-0 w-20 h-20 bg-accent/5 rounded-full -mr-5 -mt-5"></div>
                            <h4 class="text-lg font-bold text-gray-900 mb-2">${s.name}</h4>
                            <p class="text-gray-600 text-sm leading-relaxed mb-4">${s.description}</p>
                            <div class="flex items-end justify-between border-t border-gray-100 pt-4">
                                <div><p class="text-xs text-gray-400 uppercase font-bold">Investimento Estimado</p><p class="text-2xl font-black text-primary">R$ ${s.price.toFixed(2)}</p></div>
                                <span class="text-xs font-medium text-gray-500 bg-gray-100 px-3 py-1 rounded-full">${s.unit || 'Preço Fixo'}</span>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <p class="text-sm font-bold text-gray-700 uppercase tracking-wide">Seus Dados de Contato</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <input type="text" id="req-name" placeholder="Nome Completo" class="w-full bg-white border border-gray-200 rounded-lg p-3 text-gray-700 form-input text-sm">
                                <input type="tel" id="req-phone" placeholder="WhatsApp (DDD+Num)" class="w-full bg-white border border-gray-200 rounded-lg p-3 text-gray-700 form-input text-sm">
                            </div>
                            <input type="email" id="req-email" placeholder="E-mail Profissional" class="w-full bg-white border border-gray-200 rounded-lg p-3 text-gray-700 form-input text-sm">
                            <textarea id="req-desc" placeholder="Conte um pouco sobre seu projeto..." rows="3" class="w-full bg-white border border-gray-200 rounded-lg p-3 text-gray-700 form-input text-sm"></textarea>
                        </div>
                    </div>`; 
                const footer = `<button onclick="window.app.closeModal()" class="px-5 py-2 text-gray-500 font-bold text-sm">Cancelar</button><button onclick="window.app.submitBudgetRequest('${s.name}')" class="bg-primary hover:bg-slate-800 text-white px-8 py-2 rounded-full font-bold shadow-lg transition">Enviar Proposta</button>`; 
                window.app.openModalGeneric("Solicitar Orçamento", body, footer); 
            },

            submitBudgetRequest: (serviceName) => {
                const name = document.getElementById('req-name').value;
                const email = document.getElementById('req-email').value;
                const phone = document.getElementById('req-phone').value;
                const desc = document.getElementById('req-desc').value;

                if(!name || !email || !phone) return window.app.toast('Preencha nome, e-mail e telefone!', 'error');

                DB.leads.unshift({ 
                    id: Date.now(), name, email, phone, desc, 
                    service: serviceName, 
                    value: 0, // A definir
                    date: new Date().toLocaleDateString('pt-BR'), 
                    status: 'pending',
                    timestamp: Date.now()
                });

                window.app.toast('Solicitação enviada com sucesso!', 'success'); 
                window.app.closeModal();
            },
        };

        window.addEventListener('hashchange', router);
        window.addEventListener('load', () => {
            document.getElementById('header-container').innerHTML = TEMPLATES.header;
            initHeaderLogic();
            document.getElementById('footer-container').innerHTML = `<footer class="bg-primary text-white py-16 border-t-4 border-accent text-center"><h4 class="font-serif text-3xl font-bold mb-6">RONALDO <span class="text-accent">PEREIRA</span>.</h4><div class="flex justify-center gap-6 mb-8 text-2xl text-slate-400"><i class="ph-fill ph-instagram hover:text-white cursor-pointer transition"></i><i class="ph-fill ph-twitter-logo hover:text-white cursor-pointer transition"></i><i class="ph-fill ph-envelope-simple hover:text-white cursor-pointer transition"></i></div><p class="text-slate-500 text-sm">&copy; 2025 Todos os direitos reservados.</p></footer>`;
            router();
        });
    </script>
</body>
</html>